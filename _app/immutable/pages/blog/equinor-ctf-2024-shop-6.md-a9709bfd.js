import{S as fk,i as mk,s as yk,C as zi,w as wk,x as vk,y as gk,z as bk,A as gu,f as _k,t as Ek,B as qk,Y as bu,l as o,r as i,a as r,m as p,n as l,u as c,h as n,c as u,p as k,G as vo,b as e,J as a,E as xk}from"../../chunks/index-f2a82808.js";import{L as Ak}from"../../chunks/layout-d6e193e1.js";import"../../chunks/utils-e126d158.js";function Tk(Gs){let d,m,D,B,h,E,is,Vs,go,ut,cs,bo,Zs,Ji,kt,rs,Ys,_o,dt,x,Eo,ra,qo,xo,ua,Ao,To,ht,sn,nn,$i,ft,an,tn,Qi,mt,us,en,Io,yt,on,Do,wt,ks,Eu=`<code class="language-tsx"><span class="token string">'use server'</span><span class="token punctuation">;</span>
<span class="token comment">/* eslint-disable @typescript-eslint/no-unused-vars */</span>

<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> registerUser <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../actions'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Register</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  searchParams<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">readonly</span> searchParams<span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> error <span class="token operator">=</span> searchParams<span class="token punctuation">.</span>error <span class="token keyword">as</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>row justify-content-center<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>col-md-6<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>card shadow-lg border-0 rounded-lg mt-5<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>card-header bg-primary text-white<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text-center font-weight-light my-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Register</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>card-body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>alert alert-danger mb-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
                To combat a rise in security incidents in the previous generations of EPT shop, we have temporaraly
                closed the registration. Please try again tomorrow.
              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*
  return (
    &lt;div className="container">
      &lt;div className="row justify-content-center">
        &lt;div className="col-md-6">
          &lt;div className="card shadow-lg border-0 rounded-lg mt-5">
            &lt;div className="card-header bg-primary text-white">
              &lt;h3 className="text-center font-weight-light my-4">Register&lt;/h3>
            &lt;/div>
            &lt;div className="card-body">
              &#123;error &amp;&amp; &lt;div className="alert alert-danger mb-4">&#123;error&#125;&lt;/div>&#125;
              &lt;form action=&#123;registerUser&#125;>
                &lt;div className="mb-3">
                  &lt;label htmlFor="username" className="form-label">
                    Username
                  &lt;/label>
                  &lt;div className="input-group">
                    &lt;span className="input-group-text">
                      &lt;i className="bi bi-person-fill">&lt;/i>
                    &lt;/span>
                    &lt;input type="text" className="form-control" id="username" name="username" required />
                  &lt;/div>
                &lt;/div>
                &lt;div className="mb-3">
                  &lt;label htmlFor="password" className="form-label">
                    Password
                  &lt;/label>
                  &lt;div className="input-group">
                    &lt;span className="input-group-text">
                      &lt;i className="bi bi-lock-fill">&lt;/i>
                    &lt;/span>
                    &lt;input type="password" className="form-control" id="password1" name="password1" required />
                  &lt;/div>
                &lt;/div>
                &lt;div className="mb-3">
                  &lt;label htmlFor="password" className="form-label">
                    Confirm Password
                  &lt;/label>
                  &lt;div className="input-group">
                    &lt;span className="input-group-text">
                      &lt;i className="bi bi-lock-fill">&lt;/i>
                    &lt;/span>
                    &lt;input type="password" className="form-control" id="password2" name="password2" required />
                  &lt;/div>
                &lt;/div>
                &lt;div className="d-flex align-items-center justify-content-between mt-4 mb-0">
                  &lt;button type="submit" className="btn btn-primary">
                    Register
                  &lt;/button>
                &lt;/div>
              &lt;/form>
            &lt;/div>
            &lt;div className="card-footer text-center py-3">
              &lt;div className="small">
                &lt;a href="/login">Already have an account? Sign in!&lt;/a>
              &lt;/div>
            &lt;/div>
          &lt;/div>
        &lt;/div>
      &lt;/div>
    &lt;/div>
  );
  */</span>
<span class="token punctuation">&#125;</span></code>`,vt,U,Co,ka,Po,So,gt,ds,qu=`<code class="language-ts"><span class="token comment">// app/actions.ts</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">registerUser</span><span class="token punctuation">(</span>formData<span class="token operator">:</span> FormData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> password1 <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'password1'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> password2 <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'password2'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>password1 <span class="token operator">!==</span> password2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/register?error=Passwords do not match'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">const</span> existingUser <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUserByName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>existingUser<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/register?error=User already exists'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">const</span> token <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>password1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">createUser</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> hashedPassword<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/login?success=Registration successful! Please log in.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/register?error=Something went wrong, please try again.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code>`,bt,pn,Fo,_t,ln,No,Et,cn,Oo,qt,hs,xu=`<code class="language-tsx"><span class="token comment">// app/components/ItemCard.tsx</span>
<span class="token operator">&lt;</span>form
  action<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token string">'use server'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token operator">?.</span>money <span class="token operator">>=</span> item<span class="token punctuation">.</span>price<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">addItem</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setMoney</span><span class="token punctuation">(</span>user<span class="token operator">?.</span>money <span class="token operator">-</span> item<span class="token punctuation">.</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">/?error=Insufficient funds to buy </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>item<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">/?login&amp;error=You need to login in order to buy </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>item<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
<span class="token operator">></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    Buy
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></code>`,xt,fs,Au=`<code class="language-tsx"><span class="token comment">// app/items/page.tsx</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span>
  <span class="token attr-name">action</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token string">'use server'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>retailer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">removeItem</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setMoney</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>money <span class="token operator">+</span> item<span class="token punctuation">.</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/items?error=Only retailers can sell items'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></span>
<span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-danger<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    Sell
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></code>`,At,M,Ro,da,jo,Ho,Tt,ms,Tu=`<code class="language-ts"><span class="token comment">// app/db.ts</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">makeRetailer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  db<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">'UPDATE users SET retailer = ? WHERE id = ?'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">true</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code>`,It,rn,Lo,Dt,v,Ko,ha,Wo,Bo,fa,Uo,Mo,ma,Xo,zo,Ct,ys,un,Jo,Pt,kn,$o,St,X,Qo,C,Go,Vo,Ft,z,ya,Zo,Yo,wa,sp,Nt,dn,np,Ot,ws,hn,ap,Rt,fn,tp,jt,P,ep,va,op,pp,S,lp,Ht,mn,ip,Lt,y,ga,cp,rp,yn,up,wn,ba,kp,dp,vn,hp,gn,_a,fp,mp,J,yp,Ea,wp,vp,A,qa,gp,bp,xa,_p,Ep,Aa,qp,Kt,bn,xp,Wt,vs,Iu=`<code class="language-undefined">&#123;
  &quot;node&quot;: &#123;
    &quot;e55288980c2aa166e63d652496ef4cb5a59fe71b&quot;: &#123;
      &quot;workers&quot;: &#123;
        &quot;app/_not-found/page&quot;: &quot;3641&quot;,
        &quot;app/page&quot;: &quot;6853&quot;,
        &quot;app/items/page&quot;: &quot;7058&quot;,
        &quot;app/register/page&quot;: &quot;6770&quot;,
        &quot;app/login/page&quot;: &quot;1354&quot;
      &#125;,
      &quot;layer&quot;: &#123;
        &quot;app/_not-found/page&quot;: &quot;rsc&quot;,
        &quot;app/page&quot;: &quot;rsc&quot;,
        &quot;app/items/page&quot;: &quot;rsc&quot;,
        &quot;app/register/page&quot;: &quot;rsc&quot;,
        &quot;app/login/page&quot;: &quot;rsc&quot;
      &#125;
    &#125;,
    &quot;73e81bf6d2f360e2dbcca467b38d6d3485416a80&quot;: &#123;
      &quot;workers&quot;: &#123;
        &quot;app/login/page&quot;: &quot;1354&quot;
      &#125;,
      &quot;layer&quot;: &#123;
        &quot;app/login/page&quot;: &quot;rsc&quot;
      &#125;
    &#125;
  &#125;,
  &quot;edge&quot;: &#123;&#125;,
  &quot;encryptionKey&quot;: &quot;mJAPusl5apVZ8FEgO0pOxHh/c8gRvX1ZVIzcV+y7WtE=&quot;
&#125;</code>`,Bt,gs,_n,Ap,Ut,En,Tp,Mt,bs,qn,Ip,Xt,w,Dp,Ta,Cp,Pp,Ia,Sp,Fp,F,Np,Op,N,Rp,zt,xn,jp,Jt,An,Hp,$t,_s,Du=`<code class="language-tsx"><span class="token string">'use server'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loginUser</span><span class="token punctuation">(</span>formData<span class="token operator">:</span> FormData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> password <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">// Process the form data</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span>loginUser<span class="token punctuation">&#125;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Login</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code>`,Qt,Tn,Lp,Gt,Es,Cu=`<code class="language-tsx"><span class="token string">'use server'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Process the form data</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span>loginUser<span class="token punctuation">&#125;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Login</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code>`,Vt,g,Kp,Da,Wp,Bp,Ca,Up,Mp,Pa,Xp,zp,Zt,qs,Pu=`<code class="language-undefined">POST /login HTTP/2
Host: www.example.com
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryToyTbSR91Ei4Fmrd
Content-Length: XXX

------WebKitFormBoundaryToyTbSR91Ei4Fmrd
Content-Disposition: form-data; name=&quot;$ACTION_ID_674d520b41ccc6f326424b41b57befe8f5ca78e4&quot;


------WebKitFormBoundaryToyTbSR91Ei4Fmrd
Content-Disposition: form-data; name=&quot;username&quot;

Shirajuki
------WebKitFormBoundaryToyTbSR91Ei4Fmrd
Content-Disposition: form-data; name=&quot;password&quot;

asdzxc123
------WebKitFormBoundaryToyTbSR91Ei4Fmrd--</code>`,Yt,f,Jp,Sa,$p,Qp,Fa,Gp,Vp,Na,Zp,Yp,Oa,sl,nl,Ra,al,tl,se,In,el,ne,q,ja,T,Ha,ol,pl,La,ll,il,Ka,cl,rl,ul,Wa,Dn,Ba,kl,dl,hl,Ua,$,Ma,fl,ml,Xa,yl,wl,ae,Cn,vl,te,xs,Pn,gl,ee,O,bl,za,_l,El,R,ql,oe,Sn,xl,pe,As,Su=`<code class="language-tsx"><span class="token string">'use server'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> User <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../db'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">setMoney</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> formData<span class="token operator">:</span> FormData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> amount <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'amount'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span><span class="token function">setMoney</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>number<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>amount<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Motherlode</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code>`,le,Fn,Al,ie,Ts,Fu=`<code class="language-tsx"><span class="token string">'use server'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> User <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../db'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">setMoney</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span><span class="token function">setMoney</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Motherlode</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code>`,ce,Nn,Tl,re,Is,Nu=`<code class="language-undefined">POST / HTTP/2
Host: www.example.com
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary2ZnBVfhv1G12CmqK
Content-Length: XXX

------WebKitFormBoundary2ZnBVfhv1G12CmqK
Content-Disposition: form-data; name=&quot;$ACTION_REF_2&quot;


------WebKitFormBoundary2ZnBVfhv1G12CmqK
Content-Disposition: form-data; name=&quot;$ACTION_2:0&quot;

&#123;&quot;id&quot;:&quot;5033aa9e8e719350ff01f9a353595d64a7488812&quot;,&quot;bound&quot;:&quot;$@1&quot;&#125;
------WebKitFormBoundary2ZnBVfhv1G12CmqK
Content-Disposition: form-data; name=&quot;$ACTION_2:1&quot;

[10000]
------WebKitFormBoundary2ZnBVfhv1G12CmqK--</code>`,ue,Ds,Il,j,Dl,ke,Cs,On,Cl,de,Rn,Pl,he,Ps,Sl,H,Fl,fe,jn,Nl,me,Ss,Ou=`<code class="language-tsx"><span class="token string">'use server'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> User<span class="token punctuation">,</span> Item <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../db'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> redirect <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'next/navigation'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">removeItem</span><span class="token punctuation">(</span>itemName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">setMoney</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Sell</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> user<span class="token punctuation">,</span> item <span class="token punctuation">&#125;</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token keyword">readonly</span> user<span class="token operator">:</span> User <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token keyword">readonly</span> item<span class="token operator">:</span> Item <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span>
      <span class="token attr-name">action</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token string">'use server'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>retailer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">removeItem</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">setMoney</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>money <span class="token operator">+</span> item<span class="token punctuation">.</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
          <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/items?error=Only retailers can sell items'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></span>
    <span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Sell</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code>`,ye,Hn,Ol,we,Fs,Ru=`<code class="language-undefined">POST /items HTTP/2
Host: www.example.com
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryUDUZv2eADcIFY6kH
Content-Length: XXX

------WebKitFormBoundaryUDUZv2eADcIFY6kH
Content-Disposition: form-data; name=&quot;$ACTION_REF_2&quot;


------WebKitFormBoundaryUDUZv2eADcIFY6kH
Content-Disposition: form-data; name=&quot;$ACTION_2:0&quot;

&#123;&quot;id&quot;:&quot;8096ba709448aa04f5b916405bc2620e6b7b1e0a&quot;,&quot;bound&quot;:&quot;$@1&quot;&#125;
------WebKitFormBoundaryUDUZv2eADcIFY6kH
Content-Disposition: form-data; name=&quot;$ACTION_2:1&quot;

[&quot;$@2&quot;]
------WebKitFormBoundaryUDUZv2eADcIFY6kH
Content-Disposition: form-data; name=&quot;$ACTION_2:2&quot;

&quot;dPs9K3zSEOjED8k17zAAaqeHQ0ESD/5+Mu+dPVpFDpRsB3x/8nbZzrocrbp1RIGtUCZ7W1SOtWdIUGEccTAWDt6KpNMQvp9CiCYdTrNWDZ/yU9Lhvs7T457Eh5FHtw9PvF4cxpUQsNDAVXk3h2+P&quot;
------WebKitFormBoundaryUDUZv2eADcIFY6kH--</code>`,ve,Q,Rl,Ja,jl,Hl,ge,Ns,ju=`<code class="language-tsx"><span class="token operator">&lt;</span>form
  action<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token string">'use server'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// The user's serialized state is saved in the request, meaning that this</span>
      <span class="token comment">// verification check runs on the same data even when replayed</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token operator">?.</span>money <span class="token operator">>=</span> item<span class="token punctuation">.</span>price<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">addItem</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setMoney</span><span class="token punctuation">(</span>user<span class="token operator">?.</span>money <span class="token operator">-</span> item<span class="token punctuation">.</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">/?error=Insufficient funds to buy </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>item<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">/?login&amp;error=You need to login in order to buy </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>item<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
<span class="token operator">></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    Buy
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></code>`,be,b,Ll,$a,Kl,Wl,Qa,Bl,Ul,Ga,Ml,Xl,_e,Ln,zl,Ee,Os,Hu=`<code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">addItem</span><span class="token punctuation">(</span>itemName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> item <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT id FROM items WHERE name = ?'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>itemName<span class="token punctuation">)</span> <span class="token keyword">as</span> Item <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  db<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">'INSERT INTO user_items (user_id, item_id) VALUES (?, ?)'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> item<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">setMoney</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  db<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">'UPDATE users SET money = ? WHERE id = ?'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>amount<span class="token punctuation">,</span> user<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code>`,qe,Rs,Kn,Jl,xe,G,$l,L,Ql,Gl,Ae,I,Vl,Va,Zl,Yl,Za,si,ni,Te,js,Lu=`<code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> NextRequest<span class="token punctuation">,</span> NextResponse <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'next/server'</span><span class="token punctuation">;</span>

<span class="token comment">// Make sure we are fully SSR complient and not using any client-side JS</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">middleware</span><span class="token punctuation">(</span>request<span class="token operator">:</span> NextRequest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Next-Action'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NextResponse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token number">403</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> NextResponse<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">)</span><span class="token operator">?.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'text/x-component'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NextResponse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token number">403</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Content-Security-Policy'</span><span class="token punctuation">,</span> <span class="token string">"script-src 'none';"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  matcher<span class="token operator">:</span> <span class="token string">'/:path*'</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code>`,Ie,Wn,ai,De,Hs,Ku=`<code class="language-undefined">POST / HTTP/2
Host: www.example.com
Content-Type: text/plain; charset=UTF-8
Next-Action: 5033aa9e8e719350ff01f9a353595d64a7488812
Content-Length: XXX

[1337]</code>`,Ce,V,ti,Ya,ei,oi,Pe,Bn,pi,Se,Ls,Un,li,Fe,Mn,ii,Ne,Xn,ci,Oe,Ks,Wu=`<code class="language-undefined">POST / HTTP/2
Host: ikutoppene-XXXX-shop-6.ept.gg
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Length: 472

------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_ID_22848b167831802fadcb34db9cc648e9d77b665f&quot;


------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;username&quot;

shirajuki
------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;password1&quot;

asdzxc123
------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;password2&quot;

asdzxc123
------WebKitFormBoundaryQApJRAsTKClOX1Fa--</code>`,Re,zn,ri,je,Ws,Jn,ui,He,$n,ki,Le,Z,di,st,hi,fi,Ke,Bs,Bu=`<code class="language-undefined">POST /items HTTP/2
Host: ikutoppene-XXXX-shop-6.ept.gg
Cookie: token=344e1360bd35ec2f26fcf058950d27d6
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Length: 409

------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_REF_2&quot;


------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_2:0&quot;

&#123;&quot;id&quot;:&quot;5033aa9e8e719350ff01f9a353595d64a7488812&quot;,&quot;bound&quot;:&quot;$@1&quot;&#125;
------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_2:1&quot;

[9001]
------WebKitFormBoundaryQApJRAsTKClOX1Fa--
</code>`,We,Us,Qn,mi,Be,Gn,yi,Ue,Y,wi,nt,vi,gi,Me,Ms,Uu=`<code class="language-undefined">POST /items HTTP/2
Host: ikutoppene-XXXX-shop-6.ept.gg
Cookie: token=344e1360bd35ec2f26fcf058950d27d6
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Length: 421


------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_REF_2&quot;


------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_2:0&quot;

&#123;&quot;id&quot;:&quot;240aa4f8f6a6e8c0edfbc1f6b473afaa2164e7b7&quot;,&quot;bound&quot;:&quot;$@1&quot;&#125;
------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_2:1&quot;

[&quot;EPT Tote Bag&quot;]
------WebKitFormBoundaryQApJRAsTKClOX1Fa--</code>`,Xe,Xs,Vn,bi,ze,Zn,_i,Je,ss,Ei,at,qi,xi,$e,zs,Mu=`<code class="language-undefined">POST / HTTP/2
Host: ikutoppene-XXXX-shop-6.ept.gg
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Length: 182

------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_ID_758c88ac2c11c3f9c5eac5df2912014fc02de432&quot;


------WebKitFormBoundaryQApJRAsTKClOX1Fa--</code>`,Qe,ns,Ai,tt,Ti,Ii,Ge,Js,Xu=`<code class="language-undefined">POST / HTTP/2
Host: ikutoppene-XXXX-shop-6.ept.gg
Cookie: token=344e1360bd35ec2f26fcf058950d27d6
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Length: 858

------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_REF_2&quot;


------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_2:1&quot;

[&quot;$@2&quot;]
------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_2:0&quot;

&#123;&quot;id&quot;:&quot;9337c109f875b15e8546173b9d015d3123b9728c&quot;,&quot;bound&quot;:&quot;$@1&quot;&#125;
------WebKitFormBoundaryQApJRAsTKClOX1Fa
Content-Disposition: form-data; name=&quot;$ACTION_2:2&quot;

&quot;12wBRqePUMo/+f7x2mV3ihIJ/a6k5k2B5z0VTQHt8UrAYMwwV7iMngSRK4SQHC7nEGRqFCnIJj+SqqENKz0AD1g9mMP2p4vIXU7vZLhYws4en88FdxAMLfSlAtRofz5prCbpfUVKUoMsYV78AA3y5YoIIjr5NmelPAfl1FD6DLx+zWwjy39McbcH9ON8+OdUbijPVKDHz/fHABeGz1yVV5zBOSpJKwZcnPaAXGs16DaiD3rH9IkgabM34v0OI80hlp+E4wapntsDJbcHF8ZRfrPWglO2AJ5IXmqnRkybPPCQF9wezVgW3JDbcPejHcAU4MuGOLUnrisTPM6jpt3GPGPbyLM=&quot;
------WebKitFormBoundaryQApJRAsTKClOX1Fa--</code>`,Ve,as,Di,et,Ci,Pi,Ze,ts,ot,Si,Fi,pt,Ni,Ye,Yn,sa,Gi,so,$s,na,Oi,no,aa,Ri,ao,ta,ji,to,ea,Hi,eo,oa,K,Li;return{c(){d=o("h2"),m=o("a"),D=i("Introduction"),B=r(),h=o("p"),E=i("\u{1F525} Shop 6 \u{1F525}was a web challenge and one of six fire challenges in Equinor CTF 2024, authored by null. To solve this challenge, it was necessary to make use of Next.js Server Actions\u2019 trait of being publicly accessible to the client. Additionally, there was a logical flaw in implementing the item purchasing functionality, where Server Actions acted as closures, essentially leading to a desynchronization between the user\u2019s state and the database."),is=r(),Vs=o("p"),go=i("This CTF challenge was also white box, meaning the source code and necessary Dockerfiles were provided. Along with the source code, we also received a URL directing us to the live server."),ut=r(),cs=o("p"),bo=i(`The challenge description is as follows:
`),Zs=o("img"),kt=r(),rs=o("h2"),Ys=o("a"),_o=i("Overview"),dt=r(),x=o("p"),Eo=i("Upon reviewing the hosted web application, we get a clearer idea of what the challenge is about. It is more or less very similar to challenges under the same series, like "),ra=o("code"),qo=i("Shop 4"),xo=i(" and "),ua=o("code"),Ao=i("Shop 5"),To=i(", where the premise and goal is to purchase a specific item containing the flag. However, a major difference in this challenge is that we cannot seem to register an account from the get-go. This is where the provided source code and Dockerfiles came in handy."),ht=r(),sn=o("p"),nn=o("img"),ft=r(),an=o("p"),tn=o("img"),mt=r(),us=o("h2"),en=o("a"),Io=i("Analysis"),yt=r(),on=o("p"),Do=i("Knowing that we need to figure out a way to enable user registration first to proceed to the application\u2019s functionalities, we can start by reviewing the code responsible for handling this functionality. The first hint we can see when doing so comes from the commented-out JSX snippets in the source code, intended to handle the registration form."),wt=r(),ks=o("pre"),vt=r(),U=o("p"),Co=i("Since most of the JSX code is commented out, the imported server action "),ka=o("code"),Po=i("registerUser(formData: FormData)"),So=i(", intended to handle user registration, seems to be unused. The code for the server action looked as follows:"),gt=r(),ds=o("pre"),bt=r(),pn=o("p"),Fo=i("From the looks of it, the only way of registering a user is through triggering this said exported server action with the required FormData parameter. And when once registered, we should then have access to the shop\u2019s intended functionalities, including buying and selling items."),_t=r(),ln=o("p"),No=i("However, there seems to be an additional hurdle after the registration, specifically in the selling functionality where selling items requires a retailer role, which we don\u2019t initially have. Let\u2019s keep on tracing."),Et=r(),cn=o("p"),Oo=i("The following are the codes for the buy and sell functionality respectively:"),qt=r(),hs=o("pre"),xt=r(),fs=o("pre"),At=r(),M=o("p"),Ro=i("Looking around the source code further, we find that the only code path to set a user\u2019s retailer role is through the server action "),da=o("code"),jo=i("makeRetailer()"),Ho=i(". Interestingly, same with the code for registration, this function is unused and not called anywhere either. It is also important to note that this function does not have any validation whatsoever other than that the user is checked to be authenticated."),Tt=r(),ms=o("pre"),It=r(),rn=o("p"),Lo=i(`Assuming we can register a user and set ourselves as a retailer, having access to both buy and sell functionalities, we still need a way to increase our balance beyond the initial 100 to afford the EPT tote bag containing the flag.
Taking inspiration from the other challenges in the same series, revisiting the buy and sell methods may reveal a way to achieve this.`),Dt=r(),v=o("p"),Ko=i("In summary, from the analysis, we can figure that the first obstacle is to register a user. Once registered, the next step is to find a way to call the exported server actions such as "),ha=o("code"),Wo=i("makeRetailer"),Bo=i(" or similarly, "),fa=o("code"),Uo=i("addItem"),Mo=i(" or "),ma=o("code"),Xo=i("setMoney"),zo=i(". These actions could enable the selling functionality or directly add the item containing the flag to our inventory. Alternatively, if these actions are not accessible but we still somehow can become a retailer, exploiting the buy/sell logic to increase our balance could provide the money we need to net us the flag as well."),Ct=r(),ys=o("h2"),un=o("a"),Jo=i("Understanding Next.js 14 server actions"),Pt=r(),kn=o("p"),$o=i("But before diving into exploiting the application, let\u2019s take a look at Next.js server actions and the underlying magic as in how they work first. Note that since the challenge application runs on Next.js 14.2.15, much of what is discovered below may only apply specifically to this version."),St=r(),X=o("p"),Qo=i("Before we start, a high-level understanding of what Server Actions are and how they can be used can be seen and outlined in the "),C=o("a"),Go=i("Next.js documentation"),Vo=i(". The following are some snippets taken directly from it:"),Ft=r(),z=o("blockquote"),ya=o("p"),Zo=i("Server Actions in Next.js are asynchronous functions that are executed on the server. They can be called in Server and Client Components to handle form submissions and data mutations in Next.js applications."),Yo=r(),wa=o("p"),sp=i("A Server Action can be defined with the React \u201Cuse server\u201D directive. You can place the directive at the top of an async function to mark the function as a Server Action, or at the top of a separate file to mark all exports of that file as Server Actions."),Nt=r(),dn=o("p"),np=i("With that in mind, let\u2019s explore the technical details of how they work :)"),Ot=r(),ws=o("h3"),hn=o("a"),ap=i("Server Action IDs"),Rt=r(),fn=o("p"),tp=i("In Next.js 14, when defining a Server Action, Next.js generates a unique \u201CAction ID\u201D for it. This ID is a hash calculated based on the action\u2019s specific location in the codebase and its contents it seems. This approach makes the IDs deterministic if the source code is available, meaning we can deduce or retrieve these IDs if we have the code (which we fortunately do in this case)."),jt=r(),P=o("p"),ep=i("It is important to note that this process has changed in Next.js 15 though. It is stated that "),va=o("code"),op=i('"Next.js now creates unguessable, non-deterministic IDs to allow the client to reference and call the Server Action. These IDs are periodically recalculated between builds for enhanced security"'),pp=i(". This specific change can be read in the following article: "),S=o("a"),lp=i("https://nextjs.org/blog/next-15#enhanced-security-for-server-actions"),Ht=r(),mn=o("p"),ip=i("Anyway, from my understanding, here\u2019s a summary of how Action IDs work for Next.js 14 based on reading several docs:"),Lt=r(),y=o("ul"),ga=o("li"),cp=i("When the application builds, Next.js analyzes all defined Server Actions and generates a unique ID for each one."),rp=r(),yn=o("li"),up=i("The process of generating the IDs is very dependent on the action\u2019s location as well as its contents, making the ID specific to the code structure and function details, such as parameters and arguments. This will be further mentioned later."),wn=o("ul"),ba=o("li"),kp=i("It is, therefore, important to note that changes in these factors will alter the ID"),dp=r(),vn=o("li"),hp=i("When client-side components use Server Actions, instead of having access to the actual function directly, a reference that includes this action ID will be bundled within the client code."),gn=o("ul"),_a=o("li"),fp=i("This way, it is theoretically possible to leak and expose all Server Actions placed in the same file as the action the client uses. However, this challenge application is not susceptible to this as most components use SSR."),mp=r(),J=o("li"),yp=i("A configuration file placed at "),Ea=o("code"),wp=i("./.next/server/server-reference-manifest.json"),vp=i(" is also generated during the build process, containing details about all Server Actions. This file includes:"),A=o("ul"),qa=o("li"),gp=i("All Server Action IDs (as JSON keys) in whole the application"),bp=r(),xa=o("li"),_p=i("Specific server workers (at specific page/endpoints) designated to handle each Server Action"),Ep=r(),Aa=o("li"),qp=i("An encryption key used for Server Action closures. This will also be mentioned later regarding invocating Server Actions."),Kt=r(),bn=o("p"),xp=i("The configuration structure might look something like this:"),Wt=r(),vs=o("pre"),Bt=r(),gs=o("h3"),_n=o("a"),Ap=i("Invocation and client requests"),Ut=r(),En=o("p"),Tp=i("With the Action ID in place, let\u2019s take a look at the various ways a client can invoke or call these server actions in Next.js, depending on how they\u2019re defined. Note that access to the Action ID presented above is essential for any invocation, as it uniquely identifies each Server Action in the client-to-server communication."),Mt=r(),bs=o("h4"),qn=o("a"),Ip=i("Forms"),Xt=r(),w=o("p"),Dp=i("According to the Next.js documentation, the main way to use Server Actions is via an HTML "),Ta=o("code"),Cp=i("<form>"),Pp=i(" element with the "),Ia=o("code"),Sp=i("action"),Fp=i(" prop. When the form is submitted, Next.js automatically sends the data using the "),F=o("a"),Np=i("FormData Web API"),Op=i(", allowing the action to handle and extract data from the form fields through a FormData object. More details on its usage can be found here: "),N=o("a"),Rp=i("https://nextjs.org/docs/14/app/building-your-application/data-fetching/server-actions-and-mutations#forms"),zt=r(),xn=o("p"),jp=i("An important note is that when invoked this way, the Server Action must either strictly accept only FormData as its first parameter or none at all. This constraint ensures that data can be handled correctly when passed via the form submission."),Jt=r(),An=o("p"),Hp=i("For example, we could define an action like this:"),$t=r(),_s=o("pre"),Qt=r(),Tn=o("p"),Lp=i("or alternatively, with no parameters:"),Gt=r(),Es=o("pre"),Vt=r(),g=o("p"),Kp=i("When called by the client, this action will initiate a "),Da=o("code"),Wp=i("POST"),Bp=i(" request with a "),Ca=o("code"),Up=i("Content-Type"),Mp=i(" of "),Pa=o("code"),Xp=i("multipart/form-data"),zp=i(" to the server. A typical request for this might look like the following:"),Zt=r(),qs=o("pre"),Yt=r(),f=o("p"),Jp=i("In the context of this challenge application, this means that the server actions defined in "),Sa=o("code"),$p=i("app/actions.ts"),Qp=i(", including "),Fa=o("code"),Gp=i("loginUser(formData: FormData)"),Vp=i(" and "),Na=o("code"),Zp=i("registerUser(formData: FormData)"),Yp=i(", should be accessible to us if we obtain their respective Action IDs. Similarly, the "),Oa=o("code"),sl=i("makeRetailer()"),nl=i(" function in "),Ra=o("code"),al=i("app/db.ts"),tl=i(" would also be accessible under the same conditions."),se=r(),In=o("p"),el=i("To obtain these Action IDs, we have a couple of options:"),ne=r(),q=o("ul"),ja=o("li"),T=o("p"),Ha=o("strong"),ol=i("Local Setup with Request Interception:"),pl=i(" By setting up a local instance of the application and making sure no modifications are done to the "),La=o("code"),ll=i("app/actions.ts"),il=i(" and "),Ka=o("code"),cl=i("app/db.ts"),rl=i(" files respectively, we can simulate calls to these actions if imported and used in any component. Intercepting the network requests during this process will expose the Action IDs in the request payload."),ul=r(),Wa=o("li"),Dn=o("p"),Ba=o("strong"),kl=i("Local Setup with Client-side components:"),dl=i(" Similarily, by setting up a local instance of the application and then using the server actions in client-side components. The Action IDs will be included in the bundled client code as mentioned above in my summary of how Action ID works."),hl=r(),Ua=o("li"),$=o("p"),Ma=o("strong"),fl=i("Extracting from the Server Reference Manifest:"),ml=i(" Alternatively, we can pull the Action IDs directly from the generated configuration file ("),Xa=o("code"),yl=i("./next/server/server-reference-manifest.json"),wl=i(") after setting up an instance locally. This file contains all the Action IDs alongside their associated paths."),ae=r(),Cn=o("p"),vl=i("With the Action IDs in hand, we should be able to invoke these server actions as though they were public endpoints. Thus, registration of users and giving the user the retailer role should be possible for us to exploit."),te=r(),xs=o("h4"),Pn=o("a"),gl=i("Forms alongside method binding"),ee=r(),O=o("p"),bl=i("In addition to just simply passing in FormData as a parameter, one can also pass in additional arguments to a Server Action using the "),za=o("code"),_l=i("bind"),El=i(" method as described here: "),R=o("a"),ql=i("https://nextjs.org/docs/14/app/building-your-application/data-fetching/server-actions-and-mutations#passing-additional-arguments"),oe=r(),Sn=o("p"),xl=i("For example, we can define and structure an action like this below:"),pe=r(),As=o("pre"),le=r(),Fn=o("p"),Al=i("Or alternatively, with no FormData at all:"),ie=r(),Ts=o("pre"),ce=r(),Nn=o("p"),Tl=i("The request can then look something like the following:"),re=r(),Is=o("pre"),ue=r(),Ds=o("p"),Il=i("With this structure and way of invoking the server action, one could theoretically call any Server Action with arbitrary parameters given that the Action ID is known. It is noted that the limit in this case is that the arguments given should be serializable as stated here: "),j=o("a"),Dl=i("https://react.dev/reference/rsc/use-server#serializable-parameters-and-return-values"),ke=r(),Cs=o("h4"),On=o("a"),Cl=i("Forms alongside closures"),de=r(),Rn=o("p"),Pl=i("Finally, another way to structure a Server Action is by defining it directly within a component, creating what\u2019s known as a closure. This method associates the action with a snapshot of the data state at the time of rendering, so any arguments required by the action are serialized and included in the request itself."),he=r(),Ps=o("p"),Sl=i("However, to protect sensitive data from being exposed to the client within these serialized snapshots, Next.js encrypts the data using a unique encryption key generated at each build. This encryption ensures that closure-based actions can only be invoked within the specific build context they were generated for, adding a layer of security by binding them to that build. For further details, Next.js provides a helpful overview here: "),H=o("a"),Fl=i("https://nextjs.org/blog/security-nextjs-server-components-actions#closures"),fe=r(),jn=o("p"),Nl=i("Like the above sections, here\u2019s an example of how a closure could look like:"),me=r(),Ss=o("pre"),ye=r(),Hn=o("p"),Ol=i("The request against closures would look similar to request against the the bounded actions, but with the difference in that the argument are encrypted:"),we=r(),Fs=o("pre"),ve=r(),Q=o("p"),Rl=i(`In the context of the challenge application, this makes closures a bit trickier to exploit since we can\u2019t easily manipulate the argument values directly within the client.
However, since the data is serialized and the state snapshot is embedded within the request, any verification logic, like the if-check in `),Ja=o("code"),jl=i("app/components/ItemCard.tsx"),Hl=i(", is tightly linked to the state captured when the request is generated:"),ge=r(),Ns=o("pre"),be=r(),b=o("p"),Ll=i("This setup implies that once we buy an item we can afford, we could replay the same request, which would still pass the "),$a=o("code"),Kl=i("user?.money >= item.price"),Wl=i(" check. Each replayed request would trigger both the "),Qa=o("code"),Bl=i("addItem"),Ul=i(" and "),Ga=o("code"),Ml=i("setMoney"),Xl=i(" Server Actions, creating a desynchronization between the request state and the backend database state."),_e=r(),Ln=o("p"),zl=i("As a result, each request replay would add the item to our inventory again while setting the money back to a constant value, allowing us to bypass spending limits. This would enable us to buy the item multiple times without actually losing any more money than the first initial purchase:"),Ee=r(),Os=o("pre"),qe=r(),Rs=o("h4"),Kn=o("a"),Jl=i("Next-Action header"),xe=r(),G=o("p"),$l=i("Lastly, this is one of the more mysterious aspects of how Server Actions work, with very little documentation available on the internet aside from a few scattered examples found in Stack Overflow discussions, blogs, and articles. It seemed that this header is suppoed to be used under the hood in Next.js to trigger Server actions. For instance, you can take a look at this snippet from Next.js\u2019 source code on how requests are parsed: "),L=o("a"),Ql=i("https://github.com/vercel/next.js/blob/v14.2.15/packages/next/src/client/components/router-reducer/reducers/server-action-reducer.ts#L149"),Gl=i(". But essentially, this means that any request to the server with the header Next-Action would trigger a specific Server Action based on the header\u2019s value (Action ID)."),Ae=r(),I=o("p"),Vl=i("However, in the context of the challenge application, there was one file we didn\u2019t investigate during our initial analysis, the "),Va=o("code"),Zl=i("middleware.ts"),Yl=i(" file. This file ensured that all requests containing the "),Za=o("code"),si=i("Next-Action"),ni=i(" header, which were not explicitly made by the server, are blocked. Specifically, responding with a 403 Forbidden status code:"),Te=r(),js=o("pre"),Ie=r(),Wn=o("p"),ai=i("If there was no such middleware, one could have simply sent the following request to invoke a Server Action with arbitrary parameters (not that it really matters, since we could call the Server Actions using Forms and requests for bounded actions anyway):"),De=r(),Hs=o("pre"),Ce=r(),V=o("p"),ti=i("Great\u2026 So, what does all this mean for us? Essentially, as Next.js have kept on emphasizing throughout its documentation, "),Ya=o("code"),ei=i('"You should basically treat Server Actions as public HTTP endpoints."'),oi=i(" This means validation is a must when working with Server Actions, as they\u2019re accessible to clients and potentially vulnerable if mishandled. In the case of this challenge application, several unused Server Actions without proper validation were left exposed, making them accessible to all clients."),Pe=r(),Bn=o("p"),pi=i(`Now with all that said, much of the findings above were gathered after the CTF to deepen my understanding of how things work in Next.js under the hood.
During the competition how I got the first blood on the challenge, however, my approach was less structured. I mindlessly went havoc on the keyboard, my brains went brrr, and in combination with having a quick skim through the documentations, the flag just appeared\u2026`),Se=r(),Ls=o("h2"),Un=o("a"),li=i("Exploitation"),Fe=r(),Mn=o("p"),ii=i("Cool, with the knowledge-sharing done! Let\u2019s take a look at the exploitation now :)"),Ne=r(),Xn=o("p"),ci=i("We start by setting up a local instance, where the registration page is modified by uncommenting the code for the forms in order for us to register a user locally. By replaying the request against the live server using the same Action ID, we could register a user successfully."),Oe=r(),Ks=o("pre"),Re=r(),zn=o("p"),ri=i("Now, with all the things we\u2019ve gone through to understand how Server Actions work, we should have at least 3 paths to get the flag."),je=r(),Ws=o("h3"),Jn=o("a"),ui=i("Path 1 - Rosebud, kaching and motherlode"),He=r(),$n=o("p"),ki=i("We could send a request usually used with bounded actions to arbitrarily set our balance to any desired value, effectively bypassing any intended limitations. With our balance set sufficiently high, we could then simply purchase the EPT Tote Bag that contains the flag, completing the challenge without needing any additional exploits."),Le=r(),Z=o("p"),di=i("In the request shown below, we basically call "),st=o("code"),hi=i("setMoney.bind(null, 9001)()"),fi=i("."),Ke=r(),Bs=o("pre"),We=r(),Us=o("h3"),Qn=o("a"),mi=i("Path 2 - EPT Tote Bag directly in my bag"),Be=r(),Gn=o("p"),yi=i("Similarily, an even easier way is to just simply add the EPT Tote Bag containing the flag, directly to our inventory."),Ue=r(),Y=o("p"),wi=i("In the request shown below, we basically call "),nt=o("code"),vi=i('addItem.bind(null, "EPT Tote Bag")()'),gi=i("."),Me=r(),Ms=o("pre"),Xe=r(),Xs=o("h3"),Vn=o("a"),bi=i("Path 3 - State desynchronization through closures"),ze=r(),Zn=o("p"),_i=i("Unfortunately, I did not know of the method of binding Server Actions as shown in the exploits and requests above. Instead, I focused on exploiting the buy/sell functionality after successfully registering a user and setting the user\u2019s retailer role."),Je=r(),ss=o("p"),Ei=i("In the request shown below, we basically call "),at=o("code"),qi=i("makeRetailer()"),xi=i("."),$e=r(),zs=o("pre"),Qe=r(),ns=o("p"),Ai=i("After that, with the idea of closures we had discussed above about how the state is serialized and saved in the requests itself. We can buy the "),tt=o("code"),Ti=i("Fun"),Ii=i(" item and then replay the same request at least 26 times for the necessary items we could resell."),Ge=r(),Js=o("pre"),Ve=r(),as=o("p"),Di=i("With this, we should have lots of the "),et=o("code"),Ci=i("Fun"),Pi=i(" items added to our inventory. Manually selling each and every item should give us enough balance for the EPT Tote Bag."),Ze=r(),ts=o("p"),ot=o("strong"),Si=i("Boom, flag!"),Fi=r(),pt=o("code"),Ni=i("EPT{3v3ry7hin6_i5_4_5erv3r_4cti0n_1f_y0u_7ry_h4rd_en0ugh!}"),Ye=r(),Yn=o("p"),sa=o("img"),so=r(),$s=o("h1"),na=o("a"),Oi=i("Conclusion"),no=r(),aa=o("p"),Ri=i("To wrap up this write-up, I would like to thank my teammates at Iku-toppene for the great teamwork during the CTF. Solving this challenge was definitely a team effort alongside my bigshot teammate, olefredrik, and not something I had done just alone. Additionally, I would like to express my greatest appreciation to the Equinor Pwn Team (EPT) for hosting such an amazing CTF and for the high-quality challenges. Finally, a special thanks to the people who reached out after the CTF and started discussions with me, this greatly encouraged me to further explore and piece together the findings shared above."),ao=r(),ta=o("p"),ji=i("Thank you for reading!"),to=r(),ea=o("p"),Hi=i("Oh, and by the way\u2026 here\u2019s a video of the Fire \u{1F525} announcement for getting first blood on this challenge during the CTF \u{1F60E}"),eo=r(),oa=o("p"),K=o("a"),Li=i("https://github.com/user-attachments/assets/51e44009-2048-4251-b7de-fa1ec84d66fc"),this.h()},l(s){d=p(s,"H2",{id:!0});var t=l(d);m=p(t,"A",{href:!0});var Vi=l(m);D=c(Vi,"Introduction"),Vi.forEach(n),t.forEach(n),B=u(s),h=p(s,"P",{});var Zi=l(h);E=c(Zi,"\u{1F525} Shop 6 \u{1F525}was a web challenge and one of six fire challenges in Equinor CTF 2024, authored by null. To solve this challenge, it was necessary to make use of Next.js Server Actions\u2019 trait of being publicly accessible to the client. Additionally, there was a logical flaw in implementing the item purchasing functionality, where Server Actions acted as closures, essentially leading to a desynchronization between the user\u2019s state and the database."),Zi.forEach(n),is=u(s),Vs=p(s,"P",{});var Yi=l(Vs);go=c(Yi,"This CTF challenge was also white box, meaning the source code and necessary Dockerfiles were provided. Along with the source code, we also received a URL directing us to the live server."),Yi.forEach(n),ut=u(s),cs=p(s,"P",{});var Ki=l(cs);bo=c(Ki,`The challenge description is as follows:
`),Zs=p(Ki,"IMG",{src:!0,alt:!0}),Ki.forEach(n),kt=u(s),rs=p(s,"H2",{id:!0});var sc=l(rs);Ys=p(sc,"A",{href:!0});var nc=l(Ys);_o=c(nc,"Overview"),nc.forEach(n),sc.forEach(n),dt=u(s),x=p(s,"P",{});var pa=l(x);Eo=c(pa,"Upon reviewing the hosted web application, we get a clearer idea of what the challenge is about. It is more or less very similar to challenges under the same series, like "),ra=p(pa,"CODE",{});var ac=l(ra);qo=c(ac,"Shop 4"),ac.forEach(n),xo=c(pa," and "),ua=p(pa,"CODE",{});var tc=l(ua);Ao=c(tc,"Shop 5"),tc.forEach(n),To=c(pa,", where the premise and goal is to purchase a specific item containing the flag. However, a major difference in this challenge is that we cannot seem to register an account from the get-go. This is where the provided source code and Dockerfiles came in handy."),pa.forEach(n),ht=u(s),sn=p(s,"P",{});var ec=l(sn);nn=p(ec,"IMG",{src:!0,alt:!0}),ec.forEach(n),ft=u(s),an=p(s,"P",{});var oc=l(an);tn=p(oc,"IMG",{src:!0,alt:!0}),oc.forEach(n),mt=u(s),us=p(s,"H2",{id:!0});var pc=l(us);en=p(pc,"A",{href:!0});var lc=l(en);Io=c(lc,"Analysis"),lc.forEach(n),pc.forEach(n),yt=u(s),on=p(s,"P",{});var ic=l(on);Do=c(ic,"Knowing that we need to figure out a way to enable user registration first to proceed to the application\u2019s functionalities, we can start by reviewing the code responsible for handling this functionality. The first hint we can see when doing so comes from the commented-out JSX snippets in the source code, intended to handle the registration form."),ic.forEach(n),wt=u(s),ks=p(s,"PRE",{class:!0});var zu=l(ks);zu.forEach(n),vt=u(s),U=p(s,"P",{});var oo=l(U);Co=c(oo,"Since most of the JSX code is commented out, the imported server action "),ka=p(oo,"CODE",{});var cc=l(ka);Po=c(cc,"registerUser(formData: FormData)"),cc.forEach(n),So=c(oo,", intended to handle user registration, seems to be unused. The code for the server action looked as follows:"),oo.forEach(n),gt=u(s),ds=p(s,"PRE",{class:!0});var Ju=l(ds);Ju.forEach(n),bt=u(s),pn=p(s,"P",{});var rc=l(pn);Fo=c(rc,"From the looks of it, the only way of registering a user is through triggering this said exported server action with the required FormData parameter. And when once registered, we should then have access to the shop\u2019s intended functionalities, including buying and selling items."),rc.forEach(n),_t=u(s),ln=p(s,"P",{});var uc=l(ln);No=c(uc,"However, there seems to be an additional hurdle after the registration, specifically in the selling functionality where selling items requires a retailer role, which we don\u2019t initially have. Let\u2019s keep on tracing."),uc.forEach(n),Et=u(s),cn=p(s,"P",{});var kc=l(cn);Oo=c(kc,"The following are the codes for the buy and sell functionality respectively:"),kc.forEach(n),qt=u(s),hs=p(s,"PRE",{class:!0});var $u=l(hs);$u.forEach(n),xt=u(s),fs=p(s,"PRE",{class:!0});var Qu=l(fs);Qu.forEach(n),At=u(s),M=p(s,"P",{});var po=l(M);Ro=c(po,"Looking around the source code further, we find that the only code path to set a user\u2019s retailer role is through the server action "),da=p(po,"CODE",{});var dc=l(da);jo=c(dc,"makeRetailer()"),dc.forEach(n),Ho=c(po,". Interestingly, same with the code for registration, this function is unused and not called anywhere either. It is also important to note that this function does not have any validation whatsoever other than that the user is checked to be authenticated."),po.forEach(n),Tt=u(s),ms=p(s,"PRE",{class:!0});var Gu=l(ms);Gu.forEach(n),It=u(s),rn=p(s,"P",{});var hc=l(rn);Lo=c(hc,`Assuming we can register a user and set ourselves as a retailer, having access to both buy and sell functionalities, we still need a way to increase our balance beyond the initial 100 to afford the EPT tote bag containing the flag.
Taking inspiration from the other challenges in the same series, revisiting the buy and sell methods may reveal a way to achieve this.`),hc.forEach(n),Dt=u(s),v=p(s,"P",{});var es=l(v);Ko=c(es,"In summary, from the analysis, we can figure that the first obstacle is to register a user. Once registered, the next step is to find a way to call the exported server actions such as "),ha=p(es,"CODE",{});var fc=l(ha);Wo=c(fc,"makeRetailer"),fc.forEach(n),Bo=c(es," or similarly, "),fa=p(es,"CODE",{});var mc=l(fa);Uo=c(mc,"addItem"),mc.forEach(n),Mo=c(es," or "),ma=p(es,"CODE",{});var yc=l(ma);Xo=c(yc,"setMoney"),yc.forEach(n),zo=c(es,". These actions could enable the selling functionality or directly add the item containing the flag to our inventory. Alternatively, if these actions are not accessible but we still somehow can become a retailer, exploiting the buy/sell logic to increase our balance could provide the money we need to net us the flag as well."),es.forEach(n),Ct=u(s),ys=p(s,"H2",{id:!0});var wc=l(ys);un=p(wc,"A",{href:!0});var vc=l(un);Jo=c(vc,"Understanding Next.js 14 server actions"),vc.forEach(n),wc.forEach(n),Pt=u(s),kn=p(s,"P",{});var gc=l(kn);$o=c(gc,"But before diving into exploiting the application, let\u2019s take a look at Next.js server actions and the underlying magic as in how they work first. Note that since the challenge application runs on Next.js 14.2.15, much of what is discovered below may only apply specifically to this version."),gc.forEach(n),St=u(s),X=p(s,"P",{});var lo=l(X);Qo=c(lo,"Before we start, a high-level understanding of what Server Actions are and how they can be used can be seen and outlined in the "),C=p(lo,"A",{href:!0,rel:!0,class:!0,target:!0});var bc=l(C);Go=c(bc,"Next.js documentation"),bc.forEach(n),Vo=c(lo,". The following are some snippets taken directly from it:"),lo.forEach(n),Ft=u(s),z=p(s,"BLOCKQUOTE",{});var io=l(z);ya=p(io,"P",{});var _c=l(ya);Zo=c(_c,"Server Actions in Next.js are asynchronous functions that are executed on the server. They can be called in Server and Client Components to handle form submissions and data mutations in Next.js applications."),_c.forEach(n),Yo=u(io),wa=p(io,"P",{});var Ec=l(wa);sp=c(Ec,"A Server Action can be defined with the React \u201Cuse server\u201D directive. You can place the directive at the top of an async function to mark the function as a Server Action, or at the top of a separate file to mark all exports of that file as Server Actions."),Ec.forEach(n),io.forEach(n),Nt=u(s),dn=p(s,"P",{});var qc=l(dn);np=c(qc,"With that in mind, let\u2019s explore the technical details of how they work :)"),qc.forEach(n),Ot=u(s),ws=p(s,"H3",{id:!0});var xc=l(ws);hn=p(xc,"A",{href:!0});var Ac=l(hn);ap=c(Ac,"Server Action IDs"),Ac.forEach(n),xc.forEach(n),Rt=u(s),fn=p(s,"P",{});var Tc=l(fn);tp=c(Tc,"In Next.js 14, when defining a Server Action, Next.js generates a unique \u201CAction ID\u201D for it. This ID is a hash calculated based on the action\u2019s specific location in the codebase and its contents it seems. This approach makes the IDs deterministic if the source code is available, meaning we can deduce or retrieve these IDs if we have the code (which we fortunately do in this case)."),Tc.forEach(n),jt=u(s),P=p(s,"P",{});var lt=l(P);ep=c(lt,"It is important to note that this process has changed in Next.js 15 though. It is stated that "),va=p(lt,"CODE",{});var Ic=l(va);op=c(Ic,'"Next.js now creates unguessable, non-deterministic IDs to allow the client to reference and call the Server Action. These IDs are periodically recalculated between builds for enhanced security"'),Ic.forEach(n),pp=c(lt,". This specific change can be read in the following article: "),S=p(lt,"A",{href:!0,rel:!0,class:!0,target:!0});var Dc=l(S);lp=c(Dc,"https://nextjs.org/blog/next-15#enhanced-security-for-server-actions"),Dc.forEach(n),lt.forEach(n),Ht=u(s),mn=p(s,"P",{});var Cc=l(mn);ip=c(Cc,"Anyway, from my understanding, here\u2019s a summary of how Action IDs work for Next.js 14 based on reading several docs:"),Cc.forEach(n),Lt=u(s),y=p(s,"UL",{class:!0});var os=l(y);ga=p(os,"LI",{});var Pc=l(ga);cp=c(Pc,"When the application builds, Next.js analyzes all defined Server Actions and generates a unique ID for each one."),Pc.forEach(n),rp=u(os),yn=p(os,"LI",{});var Wi=l(yn);up=c(Wi,"The process of generating the IDs is very dependent on the action\u2019s location as well as its contents, making the ID specific to the code structure and function details, such as parameters and arguments. This will be further mentioned later."),wn=p(Wi,"UL",{class:!0});var Sc=l(wn);ba=p(Sc,"LI",{});var Fc=l(ba);kp=c(Fc,"It is, therefore, important to note that changes in these factors will alter the ID"),Fc.forEach(n),Sc.forEach(n),Wi.forEach(n),dp=u(os),vn=p(os,"LI",{});var Bi=l(vn);hp=c(Bi,"When client-side components use Server Actions, instead of having access to the actual function directly, a reference that includes this action ID will be bundled within the client code."),gn=p(Bi,"UL",{class:!0});var Nc=l(gn);_a=p(Nc,"LI",{});var Oc=l(_a);fp=c(Oc,"This way, it is theoretically possible to leak and expose all Server Actions placed in the same file as the action the client uses. However, this challenge application is not susceptible to this as most components use SSR."),Oc.forEach(n),Nc.forEach(n),Bi.forEach(n),mp=u(os),J=p(os,"LI",{});var it=l(J);yp=c(it,"A configuration file placed at "),Ea=p(it,"CODE",{});var Rc=l(Ea);wp=c(Rc,"./.next/server/server-reference-manifest.json"),Rc.forEach(n),vp=c(it," is also generated during the build process, containing details about all Server Actions. This file includes:"),A=p(it,"UL",{class:!0});var la=l(A);qa=p(la,"LI",{});var jc=l(qa);gp=c(jc,"All Server Action IDs (as JSON keys) in whole the application"),jc.forEach(n),bp=u(la),xa=p(la,"LI",{});var Hc=l(xa);_p=c(Hc,"Specific server workers (at specific page/endpoints) designated to handle each Server Action"),Hc.forEach(n),Ep=u(la),Aa=p(la,"LI",{});var Lc=l(Aa);qp=c(Lc,"An encryption key used for Server Action closures. This will also be mentioned later regarding invocating Server Actions."),Lc.forEach(n),la.forEach(n),it.forEach(n),os.forEach(n),Kt=u(s),bn=p(s,"P",{});var Kc=l(bn);xp=c(Kc,"The configuration structure might look something like this:"),Kc.forEach(n),Wt=u(s),vs=p(s,"PRE",{class:!0});var Vu=l(vs);Vu.forEach(n),Bt=u(s),gs=p(s,"H3",{id:!0});var Wc=l(gs);_n=p(Wc,"A",{href:!0});var Bc=l(_n);Ap=c(Bc,"Invocation and client requests"),Bc.forEach(n),Wc.forEach(n),Ut=u(s),En=p(s,"P",{});var Uc=l(En);Tp=c(Uc,"With the Action ID in place, let\u2019s take a look at the various ways a client can invoke or call these server actions in Next.js, depending on how they\u2019re defined. Note that access to the Action ID presented above is essential for any invocation, as it uniquely identifies each Server Action in the client-to-server communication."),Uc.forEach(n),Mt=u(s),bs=p(s,"H4",{id:!0});var Mc=l(bs);qn=p(Mc,"A",{href:!0});var Xc=l(qn);Ip=c(Xc,"Forms"),Xc.forEach(n),Mc.forEach(n),Xt=u(s),w=p(s,"P",{});var W=l(w);Dp=c(W,"According to the Next.js documentation, the main way to use Server Actions is via an HTML "),Ta=p(W,"CODE",{});var zc=l(Ta);Cp=c(zc,"<form>"),zc.forEach(n),Pp=c(W," element with the "),Ia=p(W,"CODE",{});var Jc=l(Ia);Sp=c(Jc,"action"),Jc.forEach(n),Fp=c(W," prop. When the form is submitted, Next.js automatically sends the data using the "),F=p(W,"A",{href:!0,rel:!0,class:!0,target:!0});var $c=l(F);Np=c($c,"FormData Web API"),$c.forEach(n),Op=c(W,", allowing the action to handle and extract data from the form fields through a FormData object. More details on its usage can be found here: "),N=p(W,"A",{href:!0,rel:!0,class:!0,target:!0});var Qc=l(N);Rp=c(Qc,"https://nextjs.org/docs/14/app/building-your-application/data-fetching/server-actions-and-mutations#forms"),Qc.forEach(n),W.forEach(n),zt=u(s),xn=p(s,"P",{});var Gc=l(xn);jp=c(Gc,"An important note is that when invoked this way, the Server Action must either strictly accept only FormData as its first parameter or none at all. This constraint ensures that data can be handled correctly when passed via the form submission."),Gc.forEach(n),Jt=u(s),An=p(s,"P",{});var Vc=l(An);Hp=c(Vc,"For example, we could define an action like this:"),Vc.forEach(n),$t=u(s),_s=p(s,"PRE",{class:!0});var Zu=l(_s);Zu.forEach(n),Qt=u(s),Tn=p(s,"P",{});var Zc=l(Tn);Lp=c(Zc,"or alternatively, with no parameters:"),Zc.forEach(n),Gt=u(s),Es=p(s,"PRE",{class:!0});var Yu=l(Es);Yu.forEach(n),Vt=u(s),g=p(s,"P",{});var ps=l(g);Kp=c(ps,"When called by the client, this action will initiate a "),Da=p(ps,"CODE",{});var Yc=l(Da);Wp=c(Yc,"POST"),Yc.forEach(n),Bp=c(ps," request with a "),Ca=p(ps,"CODE",{});var sr=l(Ca);Up=c(sr,"Content-Type"),sr.forEach(n),Mp=c(ps," of "),Pa=p(ps,"CODE",{});var nr=l(Pa);Xp=c(nr,"multipart/form-data"),nr.forEach(n),zp=c(ps," to the server. A typical request for this might look like the following:"),ps.forEach(n),Zt=u(s),qs=p(s,"PRE",{class:!0});var sk=l(qs);sk.forEach(n),Yt=u(s),f=p(s,"P",{});var _=l(f);Jp=c(_,"In the context of this challenge application, this means that the server actions defined in "),Sa=p(_,"CODE",{});var ar=l(Sa);$p=c(ar,"app/actions.ts"),ar.forEach(n),Qp=c(_,", including "),Fa=p(_,"CODE",{});var tr=l(Fa);Gp=c(tr,"loginUser(formData: FormData)"),tr.forEach(n),Vp=c(_," and "),Na=p(_,"CODE",{});var er=l(Na);Zp=c(er,"registerUser(formData: FormData)"),er.forEach(n),Yp=c(_,", should be accessible to us if we obtain their respective Action IDs. Similarly, the "),Oa=p(_,"CODE",{});var or=l(Oa);sl=c(or,"makeRetailer()"),or.forEach(n),nl=c(_," function in "),Ra=p(_,"CODE",{});var pr=l(Ra);al=c(pr,"app/db.ts"),pr.forEach(n),tl=c(_," would also be accessible under the same conditions."),_.forEach(n),se=u(s),In=p(s,"P",{});var lr=l(In);el=c(lr,"To obtain these Action IDs, we have a couple of options:"),lr.forEach(n),ne=u(s),q=p(s,"UL",{class:!0});var ia=l(q);ja=p(ia,"LI",{});var ir=l(ja);T=p(ir,"P",{});var Qs=l(T);Ha=p(Qs,"STRONG",{});var cr=l(Ha);ol=c(cr,"Local Setup with Request Interception:"),cr.forEach(n),pl=c(Qs," By setting up a local instance of the application and making sure no modifications are done to the "),La=p(Qs,"CODE",{});var rr=l(La);ll=c(rr,"app/actions.ts"),rr.forEach(n),il=c(Qs," and "),Ka=p(Qs,"CODE",{});var ur=l(Ka);cl=c(ur,"app/db.ts"),ur.forEach(n),rl=c(Qs," files respectively, we can simulate calls to these actions if imported and used in any component. Intercepting the network requests during this process will expose the Action IDs in the request payload."),Qs.forEach(n),ir.forEach(n),ul=u(ia),Wa=p(ia,"LI",{});var kr=l(Wa);Dn=p(kr,"P",{});var Ui=l(Dn);Ba=p(Ui,"STRONG",{});var dr=l(Ba);kl=c(dr,"Local Setup with Client-side components:"),dr.forEach(n),dl=c(Ui," Similarily, by setting up a local instance of the application and then using the server actions in client-side components. The Action IDs will be included in the bundled client code as mentioned above in my summary of how Action ID works."),Ui.forEach(n),kr.forEach(n),hl=u(ia),Ua=p(ia,"LI",{});var hr=l(Ua);$=p(hr,"P",{});var ct=l($);Ma=p(ct,"STRONG",{});var fr=l(Ma);fl=c(fr,"Extracting from the Server Reference Manifest:"),fr.forEach(n),ml=c(ct," Alternatively, we can pull the Action IDs directly from the generated configuration file ("),Xa=p(ct,"CODE",{});var mr=l(Xa);yl=c(mr,"./next/server/server-reference-manifest.json"),mr.forEach(n),wl=c(ct,") after setting up an instance locally. This file contains all the Action IDs alongside their associated paths."),ct.forEach(n),hr.forEach(n),ia.forEach(n),ae=u(s),Cn=p(s,"P",{});var yr=l(Cn);vl=c(yr,"With the Action IDs in hand, we should be able to invoke these server actions as though they were public endpoints. Thus, registration of users and giving the user the retailer role should be possible for us to exploit."),yr.forEach(n),te=u(s),xs=p(s,"H4",{id:!0});var wr=l(xs);Pn=p(wr,"A",{href:!0});var vr=l(Pn);gl=c(vr,"Forms alongside method binding"),vr.forEach(n),wr.forEach(n),ee=u(s),O=p(s,"P",{});var rt=l(O);bl=c(rt,"In addition to just simply passing in FormData as a parameter, one can also pass in additional arguments to a Server Action using the "),za=p(rt,"CODE",{});var gr=l(za);_l=c(gr,"bind"),gr.forEach(n),El=c(rt," method as described here: "),R=p(rt,"A",{href:!0,rel:!0,class:!0,target:!0});var br=l(R);ql=c(br,"https://nextjs.org/docs/14/app/building-your-application/data-fetching/server-actions-and-mutations#passing-additional-arguments"),br.forEach(n),rt.forEach(n),oe=u(s),Sn=p(s,"P",{});var _r=l(Sn);xl=c(_r,"For example, we can define and structure an action like this below:"),_r.forEach(n),pe=u(s),As=p(s,"PRE",{class:!0});var nk=l(As);nk.forEach(n),le=u(s),Fn=p(s,"P",{});var Er=l(Fn);Al=c(Er,"Or alternatively, with no FormData at all:"),Er.forEach(n),ie=u(s),Ts=p(s,"PRE",{class:!0});var ak=l(Ts);ak.forEach(n),ce=u(s),Nn=p(s,"P",{});var qr=l(Nn);Tl=c(qr,"The request can then look something like the following:"),qr.forEach(n),re=u(s),Is=p(s,"PRE",{class:!0});var tk=l(Is);tk.forEach(n),ue=u(s),Ds=p(s,"P",{});var Mi=l(Ds);Il=c(Mi,"With this structure and way of invoking the server action, one could theoretically call any Server Action with arbitrary parameters given that the Action ID is known. It is noted that the limit in this case is that the arguments given should be serializable as stated here: "),j=p(Mi,"A",{href:!0,rel:!0,class:!0,target:!0});var xr=l(j);Dl=c(xr,"https://react.dev/reference/rsc/use-server#serializable-parameters-and-return-values"),xr.forEach(n),Mi.forEach(n),ke=u(s),Cs=p(s,"H4",{id:!0});var Ar=l(Cs);On=p(Ar,"A",{href:!0});var Tr=l(On);Cl=c(Tr,"Forms alongside closures"),Tr.forEach(n),Ar.forEach(n),de=u(s),Rn=p(s,"P",{});var Ir=l(Rn);Pl=c(Ir,"Finally, another way to structure a Server Action is by defining it directly within a component, creating what\u2019s known as a closure. This method associates the action with a snapshot of the data state at the time of rendering, so any arguments required by the action are serialized and included in the request itself."),Ir.forEach(n),he=u(s),Ps=p(s,"P",{});var Xi=l(Ps);Sl=c(Xi,"However, to protect sensitive data from being exposed to the client within these serialized snapshots, Next.js encrypts the data using a unique encryption key generated at each build. This encryption ensures that closure-based actions can only be invoked within the specific build context they were generated for, adding a layer of security by binding them to that build. For further details, Next.js provides a helpful overview here: "),H=p(Xi,"A",{href:!0,rel:!0,class:!0,target:!0});var Dr=l(H);Fl=c(Dr,"https://nextjs.org/blog/security-nextjs-server-components-actions#closures"),Dr.forEach(n),Xi.forEach(n),fe=u(s),jn=p(s,"P",{});var Cr=l(jn);Nl=c(Cr,"Like the above sections, here\u2019s an example of how a closure could look like:"),Cr.forEach(n),me=u(s),Ss=p(s,"PRE",{class:!0});var ek=l(Ss);ek.forEach(n),ye=u(s),Hn=p(s,"P",{});var Pr=l(Hn);Ol=c(Pr,"The request against closures would look similar to request against the the bounded actions, but with the difference in that the argument are encrypted:"),Pr.forEach(n),we=u(s),Fs=p(s,"PRE",{class:!0});var ok=l(Fs);ok.forEach(n),ve=u(s),Q=p(s,"P",{});var co=l(Q);Rl=c(co,`In the context of the challenge application, this makes closures a bit trickier to exploit since we can\u2019t easily manipulate the argument values directly within the client.
However, since the data is serialized and the state snapshot is embedded within the request, any verification logic, like the if-check in `),Ja=p(co,"CODE",{});var Sr=l(Ja);jl=c(Sr,"app/components/ItemCard.tsx"),Sr.forEach(n),Hl=c(co,", is tightly linked to the state captured when the request is generated:"),co.forEach(n),ge=u(s),Ns=p(s,"PRE",{class:!0});var pk=l(Ns);pk.forEach(n),be=u(s),b=p(s,"P",{});var ls=l(b);Ll=c(ls,"This setup implies that once we buy an item we can afford, we could replay the same request, which would still pass the "),$a=p(ls,"CODE",{});var Fr=l($a);Kl=c(Fr,"user?.money >= item.price"),Fr.forEach(n),Wl=c(ls," check. Each replayed request would trigger both the "),Qa=p(ls,"CODE",{});var Nr=l(Qa);Bl=c(Nr,"addItem"),Nr.forEach(n),Ul=c(ls," and "),Ga=p(ls,"CODE",{});var Or=l(Ga);Ml=c(Or,"setMoney"),Or.forEach(n),Xl=c(ls," Server Actions, creating a desynchronization between the request state and the backend database state."),ls.forEach(n),_e=u(s),Ln=p(s,"P",{});var Rr=l(Ln);zl=c(Rr,"As a result, each request replay would add the item to our inventory again while setting the money back to a constant value, allowing us to bypass spending limits. This would enable us to buy the item multiple times without actually losing any more money than the first initial purchase:"),Rr.forEach(n),Ee=u(s),Os=p(s,"PRE",{class:!0});var lk=l(Os);lk.forEach(n),qe=u(s),Rs=p(s,"H4",{id:!0});var jr=l(Rs);Kn=p(jr,"A",{href:!0});var Hr=l(Kn);Jl=c(Hr,"Next-Action header"),Hr.forEach(n),jr.forEach(n),xe=u(s),G=p(s,"P",{});var ro=l(G);$l=c(ro,"Lastly, this is one of the more mysterious aspects of how Server Actions work, with very little documentation available on the internet aside from a few scattered examples found in Stack Overflow discussions, blogs, and articles. It seemed that this header is suppoed to be used under the hood in Next.js to trigger Server actions. For instance, you can take a look at this snippet from Next.js\u2019 source code on how requests are parsed: "),L=p(ro,"A",{href:!0,rel:!0,class:!0,target:!0});var Lr=l(L);Ql=c(Lr,"https://github.com/vercel/next.js/blob/v14.2.15/packages/next/src/client/components/router-reducer/reducers/server-action-reducer.ts#L149"),Lr.forEach(n),Gl=c(ro,". But essentially, this means that any request to the server with the header Next-Action would trigger a specific Server Action based on the header\u2019s value (Action ID)."),ro.forEach(n),Ae=u(s),I=p(s,"P",{});var ca=l(I);Vl=c(ca,"However, in the context of the challenge application, there was one file we didn\u2019t investigate during our initial analysis, the "),Va=p(ca,"CODE",{});var Kr=l(Va);Zl=c(Kr,"middleware.ts"),Kr.forEach(n),Yl=c(ca," file. This file ensured that all requests containing the "),Za=p(ca,"CODE",{});var Wr=l(Za);si=c(Wr,"Next-Action"),Wr.forEach(n),ni=c(ca," header, which were not explicitly made by the server, are blocked. Specifically, responding with a 403 Forbidden status code:"),ca.forEach(n),Te=u(s),js=p(s,"PRE",{class:!0});var ik=l(js);ik.forEach(n),Ie=u(s),Wn=p(s,"P",{});var Br=l(Wn);ai=c(Br,"If there was no such middleware, one could have simply sent the following request to invoke a Server Action with arbitrary parameters (not that it really matters, since we could call the Server Actions using Forms and requests for bounded actions anyway):"),Br.forEach(n),De=u(s),Hs=p(s,"PRE",{class:!0});var ck=l(Hs);ck.forEach(n),Ce=u(s),V=p(s,"P",{});var uo=l(V);ti=c(uo,"Great\u2026 So, what does all this mean for us? Essentially, as Next.js have kept on emphasizing throughout its documentation, "),Ya=p(uo,"CODE",{});var Ur=l(Ya);ei=c(Ur,'"You should basically treat Server Actions as public HTTP endpoints."'),Ur.forEach(n),oi=c(uo," This means validation is a must when working with Server Actions, as they\u2019re accessible to clients and potentially vulnerable if mishandled. In the case of this challenge application, several unused Server Actions without proper validation were left exposed, making them accessible to all clients."),uo.forEach(n),Pe=u(s),Bn=p(s,"P",{});var Mr=l(Bn);pi=c(Mr,`Now with all that said, much of the findings above were gathered after the CTF to deepen my understanding of how things work in Next.js under the hood.
During the competition how I got the first blood on the challenge, however, my approach was less structured. I mindlessly went havoc on the keyboard, my brains went brrr, and in combination with having a quick skim through the documentations, the flag just appeared\u2026`),Mr.forEach(n),Se=u(s),Ls=p(s,"H2",{id:!0});var Xr=l(Ls);Un=p(Xr,"A",{href:!0});var zr=l(Un);li=c(zr,"Exploitation"),zr.forEach(n),Xr.forEach(n),Fe=u(s),Mn=p(s,"P",{});var Jr=l(Mn);ii=c(Jr,"Cool, with the knowledge-sharing done! Let\u2019s take a look at the exploitation now :)"),Jr.forEach(n),Ne=u(s),Xn=p(s,"P",{});var $r=l(Xn);ci=c($r,"We start by setting up a local instance, where the registration page is modified by uncommenting the code for the forms in order for us to register a user locally. By replaying the request against the live server using the same Action ID, we could register a user successfully."),$r.forEach(n),Oe=u(s),Ks=p(s,"PRE",{class:!0});var rk=l(Ks);rk.forEach(n),Re=u(s),zn=p(s,"P",{});var Qr=l(zn);ri=c(Qr,"Now, with all the things we\u2019ve gone through to understand how Server Actions work, we should have at least 3 paths to get the flag."),Qr.forEach(n),je=u(s),Ws=p(s,"H3",{id:!0});var Gr=l(Ws);Jn=p(Gr,"A",{href:!0});var Vr=l(Jn);ui=c(Vr,"Path 1 - Rosebud, kaching and motherlode"),Vr.forEach(n),Gr.forEach(n),He=u(s),$n=p(s,"P",{});var Zr=l($n);ki=c(Zr,"We could send a request usually used with bounded actions to arbitrarily set our balance to any desired value, effectively bypassing any intended limitations. With our balance set sufficiently high, we could then simply purchase the EPT Tote Bag that contains the flag, completing the challenge without needing any additional exploits."),Zr.forEach(n),Le=u(s),Z=p(s,"P",{});var ko=l(Z);di=c(ko,"In the request shown below, we basically call "),st=p(ko,"CODE",{});var Yr=l(st);hi=c(Yr,"setMoney.bind(null, 9001)()"),Yr.forEach(n),fi=c(ko,"."),ko.forEach(n),Ke=u(s),Bs=p(s,"PRE",{class:!0});var uk=l(Bs);uk.forEach(n),We=u(s),Us=p(s,"H3",{id:!0});var su=l(Us);Qn=p(su,"A",{href:!0});var nu=l(Qn);mi=c(nu,"Path 2 - EPT Tote Bag directly in my bag"),nu.forEach(n),su.forEach(n),Be=u(s),Gn=p(s,"P",{});var au=l(Gn);yi=c(au,"Similarily, an even easier way is to just simply add the EPT Tote Bag containing the flag, directly to our inventory."),au.forEach(n),Ue=u(s),Y=p(s,"P",{});var ho=l(Y);wi=c(ho,"In the request shown below, we basically call "),nt=p(ho,"CODE",{});var tu=l(nt);vi=c(tu,'addItem.bind(null, "EPT Tote Bag")()'),tu.forEach(n),gi=c(ho,"."),ho.forEach(n),Me=u(s),Ms=p(s,"PRE",{class:!0});var kk=l(Ms);kk.forEach(n),Xe=u(s),Xs=p(s,"H3",{id:!0});var eu=l(Xs);Vn=p(eu,"A",{href:!0});var ou=l(Vn);bi=c(ou,"Path 3 - State desynchronization through closures"),ou.forEach(n),eu.forEach(n),ze=u(s),Zn=p(s,"P",{});var pu=l(Zn);_i=c(pu,"Unfortunately, I did not know of the method of binding Server Actions as shown in the exploits and requests above. Instead, I focused on exploiting the buy/sell functionality after successfully registering a user and setting the user\u2019s retailer role."),pu.forEach(n),Je=u(s),ss=p(s,"P",{});var fo=l(ss);Ei=c(fo,"In the request shown below, we basically call "),at=p(fo,"CODE",{});var lu=l(at);qi=c(lu,"makeRetailer()"),lu.forEach(n),xi=c(fo,"."),fo.forEach(n),$e=u(s),zs=p(s,"PRE",{class:!0});var dk=l(zs);dk.forEach(n),Qe=u(s),ns=p(s,"P",{});var mo=l(ns);Ai=c(mo,"After that, with the idea of closures we had discussed above about how the state is serialized and saved in the requests itself. We can buy the "),tt=p(mo,"CODE",{});var iu=l(tt);Ti=c(iu,"Fun"),iu.forEach(n),Ii=c(mo," item and then replay the same request at least 26 times for the necessary items we could resell."),mo.forEach(n),Ge=u(s),Js=p(s,"PRE",{class:!0});var hk=l(Js);hk.forEach(n),Ve=u(s),as=p(s,"P",{});var yo=l(as);Di=c(yo,"With this, we should have lots of the "),et=p(yo,"CODE",{});var cu=l(et);Ci=c(cu,"Fun"),cu.forEach(n),Pi=c(yo," items added to our inventory. Manually selling each and every item should give us enough balance for the EPT Tote Bag."),yo.forEach(n),Ze=u(s),ts=p(s,"P",{});var wo=l(ts);ot=p(wo,"STRONG",{});var ru=l(ot);Si=c(ru,"Boom, flag!"),ru.forEach(n),Fi=u(wo),pt=p(wo,"CODE",{});var uu=l(pt);Ni=c(uu,"EPT{3v3ry7hin6_i5_4_5erv3r_4cti0n_1f_y0u_7ry_h4rd_en0ugh!}"),uu.forEach(n),wo.forEach(n),Ye=u(s),Yn=p(s,"P",{});var ku=l(Yn);sa=p(ku,"IMG",{src:!0,alt:!0}),ku.forEach(n),so=u(s),$s=p(s,"H1",{id:!0});var du=l($s);na=p(du,"A",{href:!0});var hu=l(na);Oi=c(hu,"Conclusion"),hu.forEach(n),du.forEach(n),no=u(s),aa=p(s,"P",{});var fu=l(aa);Ri=c(fu,"To wrap up this write-up, I would like to thank my teammates at Iku-toppene for the great teamwork during the CTF. Solving this challenge was definitely a team effort alongside my bigshot teammate, olefredrik, and not something I had done just alone. Additionally, I would like to express my greatest appreciation to the Equinor Pwn Team (EPT) for hosting such an amazing CTF and for the high-quality challenges. Finally, a special thanks to the people who reached out after the CTF and started discussions with me, this greatly encouraged me to further explore and piece together the findings shared above."),fu.forEach(n),ao=u(s),ta=p(s,"P",{});var mu=l(ta);ji=c(mu,"Thank you for reading!"),mu.forEach(n),to=u(s),ea=p(s,"P",{});var yu=l(ea);Hi=c(yu,"Oh, and by the way\u2026 here\u2019s a video of the Fire \u{1F525} announcement for getting first blood on this challenge during the CTF \u{1F60E}"),yu.forEach(n),eo=u(s),oa=p(s,"P",{});var wu=l(oa);K=p(wu,"A",{href:!0,rel:!0,class:!0,target:!0});var vu=l(K);Li=c(vu,"https://github.com/user-attachments/assets/51e44009-2048-4251-b7de-fa1ec84d66fc"),vu.forEach(n),wu.forEach(n),this.h()},h(){k(m,"href","#introduction"),k(d,"id","introduction"),vo(Zs.src,Ji="https://raw.githubusercontent.com/Shirajuki/equinor-ctf-2024/refs/heads/main/writeups/web/Shop%206/Iku-toppene/assets/1-challenge-details.png")||k(Zs,"src",Ji),k(Zs,"alt","challenge details"),k(Ys,"href","#overview"),k(rs,"id","overview"),vo(nn.src,$i="https://raw.githubusercontent.com/Shirajuki/equinor-ctf-2024/refs/heads/main/writeups/web/Shop%206/Iku-toppene/assets/2-home-page.png")||k(nn,"src",$i),k(nn,"alt","challenge homepage"),vo(tn.src,Qi="https://raw.githubusercontent.com/Shirajuki/equinor-ctf-2024/refs/heads/main/writeups/web/Shop%206/Iku-toppene/assets/3-register-page.png")||k(tn,"src",Qi),k(tn,"alt","challenge registration page"),k(en,"href","#analysis"),k(us,"id","analysis"),k(ks,"class","language-tsx"),k(ds,"class","language-ts"),k(hs,"class","language-tsx"),k(fs,"class","language-tsx"),k(ms,"class","language-ts"),k(un,"href","#understanding-nextjs-14-server-actions"),k(ys,"id","understanding-nextjs-14-server-actions"),k(C,"href","https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations"),k(C,"rel","noopener"),k(C,"class","text-link"),k(C,"target","_blank"),k(hn,"href","#server-action-ids"),k(ws,"id","server-action-ids"),k(S,"href","https://nextjs.org/blog/next-15#enhanced-security-for-server-actions"),k(S,"rel","noopener"),k(S,"class","text-link"),k(S,"target","_blank"),k(wn,"class","list"),k(gn,"class","list"),k(A,"class","list"),k(y,"class","list"),k(vs,"class","language-undefined"),k(_n,"href","#invocation-and-client-requests"),k(gs,"id","invocation-and-client-requests"),k(qn,"href","#forms"),k(bs,"id","forms"),k(F,"href","https://developer.mozilla.org/en-US/docs/Web/API/FormData"),k(F,"rel","noopener"),k(F,"class","text-link"),k(F,"target","_blank"),k(N,"href","https://nextjs.org/docs/14/app/building-your-application/data-fetching/server-actions-and-mutations#forms"),k(N,"rel","noopener"),k(N,"class","text-link"),k(N,"target","_blank"),k(_s,"class","language-tsx"),k(Es,"class","language-tsx"),k(qs,"class","language-undefined"),k(q,"class","list"),k(Pn,"href","#forms-alongside-method-binding"),k(xs,"id","forms-alongside-method-binding"),k(R,"href","https://nextjs.org/docs/14/app/building-your-application/data-fetching/server-actions-and-mutations#passing-additional-arguments"),k(R,"rel","noopener"),k(R,"class","text-link"),k(R,"target","_blank"),k(As,"class","language-tsx"),k(Ts,"class","language-tsx"),k(Is,"class","language-undefined"),k(j,"href","https://react.dev/reference/rsc/use-server#serializable-parameters-and-return-values"),k(j,"rel","noopener"),k(j,"class","text-link"),k(j,"target","_blank"),k(On,"href","#forms-alongside-closures"),k(Cs,"id","forms-alongside-closures"),k(H,"href","https://nextjs.org/blog/security-nextjs-server-components-actions#closures"),k(H,"rel","noopener"),k(H,"class","text-link"),k(H,"target","_blank"),k(Ss,"class","language-tsx"),k(Fs,"class","language-undefined"),k(Ns,"class","language-tsx"),k(Os,"class","language-ts"),k(Kn,"href","#next-action-header"),k(Rs,"id","next-action-header"),k(L,"href","https://github.com/vercel/next.js/blob/v14.2.15/packages/next/src/client/components/router-reducer/reducers/server-action-reducer.ts#L149"),k(L,"rel","noopener"),k(L,"class","text-link"),k(L,"target","_blank"),k(js,"class","language-ts"),k(Hs,"class","language-undefined"),k(Un,"href","#exploitation"),k(Ls,"id","exploitation"),k(Ks,"class","language-undefined"),k(Jn,"href","#path-1---rosebud-kaching-and-motherlode"),k(Ws,"id","path-1---rosebud-kaching-and-motherlode"),k(Bs,"class","language-undefined"),k(Qn,"href","#path-2---ept-tote-bag-directly-in-my-bag"),k(Us,"id","path-2---ept-tote-bag-directly-in-my-bag"),k(Ms,"class","language-undefined"),k(Vn,"href","#path-3---state-desynchronization-through-closures"),k(Xs,"id","path-3---state-desynchronization-through-closures"),k(zs,"class","language-undefined"),k(Js,"class","language-undefined"),vo(sa.src,Gi="https://raw.githubusercontent.com/Shirajuki/equinor-ctf-2024/refs/heads/main/writeups/web/Shop%206/Iku-toppene/assets/4-flag.png")||k(sa,"src",Gi),k(sa,"alt","flag"),k(na,"href","#conclusion"),k($s,"id","conclusion"),k(K,"href","https://github.com/user-attachments/assets/51e44009-2048-4251-b7de-fa1ec84d66fc"),k(K,"rel","noopener"),k(K,"class","text-link"),k(K,"target","_blank")},m(s,t){e(s,d,t),a(d,m),a(m,D),e(s,B,t),e(s,h,t),a(h,E),e(s,is,t),e(s,Vs,t),a(Vs,go),e(s,ut,t),e(s,cs,t),a(cs,bo),a(cs,Zs),e(s,kt,t),e(s,rs,t),a(rs,Ys),a(Ys,_o),e(s,dt,t),e(s,x,t),a(x,Eo),a(x,ra),a(ra,qo),a(x,xo),a(x,ua),a(ua,Ao),a(x,To),e(s,ht,t),e(s,sn,t),a(sn,nn),e(s,ft,t),e(s,an,t),a(an,tn),e(s,mt,t),e(s,us,t),a(us,en),a(en,Io),e(s,yt,t),e(s,on,t),a(on,Do),e(s,wt,t),e(s,ks,t),ks.innerHTML=Eu,e(s,vt,t),e(s,U,t),a(U,Co),a(U,ka),a(ka,Po),a(U,So),e(s,gt,t),e(s,ds,t),ds.innerHTML=qu,e(s,bt,t),e(s,pn,t),a(pn,Fo),e(s,_t,t),e(s,ln,t),a(ln,No),e(s,Et,t),e(s,cn,t),a(cn,Oo),e(s,qt,t),e(s,hs,t),hs.innerHTML=xu,e(s,xt,t),e(s,fs,t),fs.innerHTML=Au,e(s,At,t),e(s,M,t),a(M,Ro),a(M,da),a(da,jo),a(M,Ho),e(s,Tt,t),e(s,ms,t),ms.innerHTML=Tu,e(s,It,t),e(s,rn,t),a(rn,Lo),e(s,Dt,t),e(s,v,t),a(v,Ko),a(v,ha),a(ha,Wo),a(v,Bo),a(v,fa),a(fa,Uo),a(v,Mo),a(v,ma),a(ma,Xo),a(v,zo),e(s,Ct,t),e(s,ys,t),a(ys,un),a(un,Jo),e(s,Pt,t),e(s,kn,t),a(kn,$o),e(s,St,t),e(s,X,t),a(X,Qo),a(X,C),a(C,Go),a(X,Vo),e(s,Ft,t),e(s,z,t),a(z,ya),a(ya,Zo),a(z,Yo),a(z,wa),a(wa,sp),e(s,Nt,t),e(s,dn,t),a(dn,np),e(s,Ot,t),e(s,ws,t),a(ws,hn),a(hn,ap),e(s,Rt,t),e(s,fn,t),a(fn,tp),e(s,jt,t),e(s,P,t),a(P,ep),a(P,va),a(va,op),a(P,pp),a(P,S),a(S,lp),e(s,Ht,t),e(s,mn,t),a(mn,ip),e(s,Lt,t),e(s,y,t),a(y,ga),a(ga,cp),a(y,rp),a(y,yn),a(yn,up),a(yn,wn),a(wn,ba),a(ba,kp),a(y,dp),a(y,vn),a(vn,hp),a(vn,gn),a(gn,_a),a(_a,fp),a(y,mp),a(y,J),a(J,yp),a(J,Ea),a(Ea,wp),a(J,vp),a(J,A),a(A,qa),a(qa,gp),a(A,bp),a(A,xa),a(xa,_p),a(A,Ep),a(A,Aa),a(Aa,qp),e(s,Kt,t),e(s,bn,t),a(bn,xp),e(s,Wt,t),e(s,vs,t),vs.innerHTML=Iu,e(s,Bt,t),e(s,gs,t),a(gs,_n),a(_n,Ap),e(s,Ut,t),e(s,En,t),a(En,Tp),e(s,Mt,t),e(s,bs,t),a(bs,qn),a(qn,Ip),e(s,Xt,t),e(s,w,t),a(w,Dp),a(w,Ta),a(Ta,Cp),a(w,Pp),a(w,Ia),a(Ia,Sp),a(w,Fp),a(w,F),a(F,Np),a(w,Op),a(w,N),a(N,Rp),e(s,zt,t),e(s,xn,t),a(xn,jp),e(s,Jt,t),e(s,An,t),a(An,Hp),e(s,$t,t),e(s,_s,t),_s.innerHTML=Du,e(s,Qt,t),e(s,Tn,t),a(Tn,Lp),e(s,Gt,t),e(s,Es,t),Es.innerHTML=Cu,e(s,Vt,t),e(s,g,t),a(g,Kp),a(g,Da),a(Da,Wp),a(g,Bp),a(g,Ca),a(Ca,Up),a(g,Mp),a(g,Pa),a(Pa,Xp),a(g,zp),e(s,Zt,t),e(s,qs,t),qs.innerHTML=Pu,e(s,Yt,t),e(s,f,t),a(f,Jp),a(f,Sa),a(Sa,$p),a(f,Qp),a(f,Fa),a(Fa,Gp),a(f,Vp),a(f,Na),a(Na,Zp),a(f,Yp),a(f,Oa),a(Oa,sl),a(f,nl),a(f,Ra),a(Ra,al),a(f,tl),e(s,se,t),e(s,In,t),a(In,el),e(s,ne,t),e(s,q,t),a(q,ja),a(ja,T),a(T,Ha),a(Ha,ol),a(T,pl),a(T,La),a(La,ll),a(T,il),a(T,Ka),a(Ka,cl),a(T,rl),a(q,ul),a(q,Wa),a(Wa,Dn),a(Dn,Ba),a(Ba,kl),a(Dn,dl),a(q,hl),a(q,Ua),a(Ua,$),a($,Ma),a(Ma,fl),a($,ml),a($,Xa),a(Xa,yl),a($,wl),e(s,ae,t),e(s,Cn,t),a(Cn,vl),e(s,te,t),e(s,xs,t),a(xs,Pn),a(Pn,gl),e(s,ee,t),e(s,O,t),a(O,bl),a(O,za),a(za,_l),a(O,El),a(O,R),a(R,ql),e(s,oe,t),e(s,Sn,t),a(Sn,xl),e(s,pe,t),e(s,As,t),As.innerHTML=Su,e(s,le,t),e(s,Fn,t),a(Fn,Al),e(s,ie,t),e(s,Ts,t),Ts.innerHTML=Fu,e(s,ce,t),e(s,Nn,t),a(Nn,Tl),e(s,re,t),e(s,Is,t),Is.innerHTML=Nu,e(s,ue,t),e(s,Ds,t),a(Ds,Il),a(Ds,j),a(j,Dl),e(s,ke,t),e(s,Cs,t),a(Cs,On),a(On,Cl),e(s,de,t),e(s,Rn,t),a(Rn,Pl),e(s,he,t),e(s,Ps,t),a(Ps,Sl),a(Ps,H),a(H,Fl),e(s,fe,t),e(s,jn,t),a(jn,Nl),e(s,me,t),e(s,Ss,t),Ss.innerHTML=Ou,e(s,ye,t),e(s,Hn,t),a(Hn,Ol),e(s,we,t),e(s,Fs,t),Fs.innerHTML=Ru,e(s,ve,t),e(s,Q,t),a(Q,Rl),a(Q,Ja),a(Ja,jl),a(Q,Hl),e(s,ge,t),e(s,Ns,t),Ns.innerHTML=ju,e(s,be,t),e(s,b,t),a(b,Ll),a(b,$a),a($a,Kl),a(b,Wl),a(b,Qa),a(Qa,Bl),a(b,Ul),a(b,Ga),a(Ga,Ml),a(b,Xl),e(s,_e,t),e(s,Ln,t),a(Ln,zl),e(s,Ee,t),e(s,Os,t),Os.innerHTML=Hu,e(s,qe,t),e(s,Rs,t),a(Rs,Kn),a(Kn,Jl),e(s,xe,t),e(s,G,t),a(G,$l),a(G,L),a(L,Ql),a(G,Gl),e(s,Ae,t),e(s,I,t),a(I,Vl),a(I,Va),a(Va,Zl),a(I,Yl),a(I,Za),a(Za,si),a(I,ni),e(s,Te,t),e(s,js,t),js.innerHTML=Lu,e(s,Ie,t),e(s,Wn,t),a(Wn,ai),e(s,De,t),e(s,Hs,t),Hs.innerHTML=Ku,e(s,Ce,t),e(s,V,t),a(V,ti),a(V,Ya),a(Ya,ei),a(V,oi),e(s,Pe,t),e(s,Bn,t),a(Bn,pi),e(s,Se,t),e(s,Ls,t),a(Ls,Un),a(Un,li),e(s,Fe,t),e(s,Mn,t),a(Mn,ii),e(s,Ne,t),e(s,Xn,t),a(Xn,ci),e(s,Oe,t),e(s,Ks,t),Ks.innerHTML=Wu,e(s,Re,t),e(s,zn,t),a(zn,ri),e(s,je,t),e(s,Ws,t),a(Ws,Jn),a(Jn,ui),e(s,He,t),e(s,$n,t),a($n,ki),e(s,Le,t),e(s,Z,t),a(Z,di),a(Z,st),a(st,hi),a(Z,fi),e(s,Ke,t),e(s,Bs,t),Bs.innerHTML=Bu,e(s,We,t),e(s,Us,t),a(Us,Qn),a(Qn,mi),e(s,Be,t),e(s,Gn,t),a(Gn,yi),e(s,Ue,t),e(s,Y,t),a(Y,wi),a(Y,nt),a(nt,vi),a(Y,gi),e(s,Me,t),e(s,Ms,t),Ms.innerHTML=Uu,e(s,Xe,t),e(s,Xs,t),a(Xs,Vn),a(Vn,bi),e(s,ze,t),e(s,Zn,t),a(Zn,_i),e(s,Je,t),e(s,ss,t),a(ss,Ei),a(ss,at),a(at,qi),a(ss,xi),e(s,$e,t),e(s,zs,t),zs.innerHTML=Mu,e(s,Qe,t),e(s,ns,t),a(ns,Ai),a(ns,tt),a(tt,Ti),a(ns,Ii),e(s,Ge,t),e(s,Js,t),Js.innerHTML=Xu,e(s,Ve,t),e(s,as,t),a(as,Di),a(as,et),a(et,Ci),a(as,Pi),e(s,Ze,t),e(s,ts,t),a(ts,ot),a(ot,Si),a(ts,Fi),a(ts,pt),a(pt,Ni),e(s,Ye,t),e(s,Yn,t),a(Yn,sa),e(s,so,t),e(s,$s,t),a($s,na),a(na,Oi),e(s,no,t),e(s,aa,t),a(aa,Ri),e(s,ao,t),e(s,ta,t),a(ta,ji),e(s,to,t),e(s,ea,t),a(ea,Hi),e(s,eo,t),e(s,oa,t),a(oa,K),a(K,Li)},p:xk,d(s){s&&n(d),s&&n(B),s&&n(h),s&&n(is),s&&n(Vs),s&&n(ut),s&&n(cs),s&&n(kt),s&&n(rs),s&&n(dt),s&&n(x),s&&n(ht),s&&n(sn),s&&n(ft),s&&n(an),s&&n(mt),s&&n(us),s&&n(yt),s&&n(on),s&&n(wt),s&&n(ks),s&&n(vt),s&&n(U),s&&n(gt),s&&n(ds),s&&n(bt),s&&n(pn),s&&n(_t),s&&n(ln),s&&n(Et),s&&n(cn),s&&n(qt),s&&n(hs),s&&n(xt),s&&n(fs),s&&n(At),s&&n(M),s&&n(Tt),s&&n(ms),s&&n(It),s&&n(rn),s&&n(Dt),s&&n(v),s&&n(Ct),s&&n(ys),s&&n(Pt),s&&n(kn),s&&n(St),s&&n(X),s&&n(Ft),s&&n(z),s&&n(Nt),s&&n(dn),s&&n(Ot),s&&n(ws),s&&n(Rt),s&&n(fn),s&&n(jt),s&&n(P),s&&n(Ht),s&&n(mn),s&&n(Lt),s&&n(y),s&&n(Kt),s&&n(bn),s&&n(Wt),s&&n(vs),s&&n(Bt),s&&n(gs),s&&n(Ut),s&&n(En),s&&n(Mt),s&&n(bs),s&&n(Xt),s&&n(w),s&&n(zt),s&&n(xn),s&&n(Jt),s&&n(An),s&&n($t),s&&n(_s),s&&n(Qt),s&&n(Tn),s&&n(Gt),s&&n(Es),s&&n(Vt),s&&n(g),s&&n(Zt),s&&n(qs),s&&n(Yt),s&&n(f),s&&n(se),s&&n(In),s&&n(ne),s&&n(q),s&&n(ae),s&&n(Cn),s&&n(te),s&&n(xs),s&&n(ee),s&&n(O),s&&n(oe),s&&n(Sn),s&&n(pe),s&&n(As),s&&n(le),s&&n(Fn),s&&n(ie),s&&n(Ts),s&&n(ce),s&&n(Nn),s&&n(re),s&&n(Is),s&&n(ue),s&&n(Ds),s&&n(ke),s&&n(Cs),s&&n(de),s&&n(Rn),s&&n(he),s&&n(Ps),s&&n(fe),s&&n(jn),s&&n(me),s&&n(Ss),s&&n(ye),s&&n(Hn),s&&n(we),s&&n(Fs),s&&n(ve),s&&n(Q),s&&n(ge),s&&n(Ns),s&&n(be),s&&n(b),s&&n(_e),s&&n(Ln),s&&n(Ee),s&&n(Os),s&&n(qe),s&&n(Rs),s&&n(xe),s&&n(G),s&&n(Ae),s&&n(I),s&&n(Te),s&&n(js),s&&n(Ie),s&&n(Wn),s&&n(De),s&&n(Hs),s&&n(Ce),s&&n(V),s&&n(Pe),s&&n(Bn),s&&n(Se),s&&n(Ls),s&&n(Fe),s&&n(Mn),s&&n(Ne),s&&n(Xn),s&&n(Oe),s&&n(Ks),s&&n(Re),s&&n(zn),s&&n(je),s&&n(Ws),s&&n(He),s&&n($n),s&&n(Le),s&&n(Z),s&&n(Ke),s&&n(Bs),s&&n(We),s&&n(Us),s&&n(Be),s&&n(Gn),s&&n(Ue),s&&n(Y),s&&n(Me),s&&n(Ms),s&&n(Xe),s&&n(Xs),s&&n(ze),s&&n(Zn),s&&n(Je),s&&n(ss),s&&n($e),s&&n(zs),s&&n(Qe),s&&n(ns),s&&n(Ge),s&&n(Js),s&&n(Ve),s&&n(as),s&&n(Ze),s&&n(ts),s&&n(Ye),s&&n(Yn),s&&n(so),s&&n($s),s&&n(no),s&&n(aa),s&&n(ao),s&&n(ta),s&&n(to),s&&n(ea),s&&n(eo),s&&n(oa)}}}function Ik(Gs){let d,m;const D=[Gs[0],_u];let B={$$slots:{default:[Tk]},$$scope:{ctx:Gs}};for(let h=0;h<D.length;h+=1)B=zi(B,D[h]);return d=new Ak({props:B}),{c(){wk(d.$$.fragment)},l(h){vk(d.$$.fragment,h)},m(h,E){gk(d,h,E),m=!0},p(h,[E]){const is=E&1?bk(D,[E&1&&gu(h[0]),E&0&&gu(_u)]):{};E&2&&(is.$$scope={dirty:E,ctx:h}),d.$set(is)},i(h){m||(_k(d.$$.fragment,h),m=!0)},o(h){Ek(d.$$.fragment,h),m=!1},d(h){qk(d,h)}}}const _u={title:"Writeup: Equinor CTF 2024 - \u{1F525} Shop 6 \u{1F525}",date:"2024-11-10",category:"writeup",description:"\u{1F525} Shop 6 \u{1F525}was a web challenge and one of six fire challenges in Equinor CTF 2024, authored by null. To solve this challenge, it was necessary to make use of Next.js Server Actions\u2019 trait of being publicly accessible to the client. Additionally, there was a logical flaw in implementing the item purchasing functionality, where Server Actions acted as closures, essentially leading to a desynchronization between the user\u2019s state and the database.",tags:["writeup","equinorctf","nextjs","server-actions"]};function Dk(Gs,d,m){return Gs.$$set=D=>{m(0,d=zi(zi({},d),bu(D)))},d=bu(d),[d]}class Fk extends fk{constructor(d){super(),mk(this,d,Dk,Ik,yk,{})}}export{Fk as default,_u as metadata};
